%%
%% texjazz-bookmark.def
%%
%% A LaTeX file to set-up bookmarks.
%%
%% Copyright (c) 2020-2021 ejazz.
%%
%---------------------------------------------------------------------------------------------------
% This work is part of the TeXjazz bundle. It may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% The Current Maintainer of this work is ejazz <ejazz.fr@gmail.com>.
%
% This work consists of the files:
%     `texjazz-bookmark.def' and `texjazz-bookmark[-fr].tex' (not yet fully available).
%---------------------------------------------------------------------------------------------------

%-- File identification
%----------------------

\ProvidesFile{texjazz-bookmark}%
  [2021/02/08 v0.1a − Configuring the bookmarks]

%---- Bookmarks − extending/improving utilities from the 'hyperref' package / Gestion des signets
%---------------------------------------------------------------------------------------------------

%- Bookmark management: still "experimental", but efficient improvement of the `hyperref' package
\RequirePackage{bookmark}% Better management of bookmarks (layout and less restriction on levels)

%----- Dealing with bookmarks
%- At a first glance, setting bookmarks is automatic when using the 'hyperref' package, but when
%- one wants to fine tune the bookmarks that's not an obvious task. Moreover, when the 'titlesec'
%- package is used − as here −, it seems that supplementary issues may occur (see 'hyperref'
%- documentation p.44: "'nameref' support 'titlesec' but hyperref' does not").
%- An overall advice is to use the 'bookmark' package, which redefines some 'hyperref' commands
%- like \pdfbookmark in terms of the new command '\bookmark' and improves the bookmark management.
%- But for a unknown reason beyond our skills (certainly coming from the defined layouts − parts,
%- chapters, etc. − with Tikz), the target bookmarks are wrong placed.
%- About that, an efficient solution is to explicitely set the anchors bookmarks at the beginning
%- of a part or chapter page.
%- The working (equivalent) solutions are given by Heiko Oberdiek and Martin Scharrer:
%-   https://tex.stackexchange.com/questions/67396/[...]
%-     [...]probem-with-bookmarks-and-linking-and-page-numbering
%-   https://tex.stackexchange.com/questions/11962/how-to-determine-current-page-number
%- It introduces the use of the Heiko Oberdiek 'zref' package.
%-----

%--- New update 2019/06/04
%- It seems now that styled and colored bookmarks can now be set for all PDF viewers. Let's try!
%-----

%----- Redefining ToC levels for correct layouts of ToCs and bookmarks
%---------------------------------------------------------------------
%- From: http://tex.stackexchange.com/questions/67132/
%-   \providecommand*{\toclevel@overparagraph}{4}
%- From: http://tex.stackexchange.com/questions/244263/bookmark-issues/
%-   \@namedef{toclevel@overparagraph}{4}
%-----

%- Setting/redefining the different bookmark levels (as for ToC levels): from 'hyperref.sty'
\def\toclevel@book{-2}% \booknumberline? It seems to be the reason: cf. bookmark.sty and memoir.cls
\def\toclevel@part{-1}%
\def\toclevel@chapter{0}%
\def\toclevel@section{1}%
\def\toclevel@subsection{2}%
\def\toclevel@subsubsection{3}%
\def\toclevel@overparagraph{4}% titletoc with hyperref doesn't define \toclevel@...
\def\toclevel@paragraph{5}% To be sure (must be settled automatically by titlesec)
\def\toclevel@subparagraph{6}% To be sure (must be settled automatically by titlesec)
%- First setting: not satisfaying with several \appendixchapter and \backchapter?
\def\toclevel@appendixchapter{-5}%{0}% titletoc with hyperref doesn't define \toclevel@...
\def\toclevel@backchapter{-6}%{0}% titletoc with hyperref doesn't define \toclevel@...
%- New attempt
%\def\toclevel@appendixchapter{0}%{0}% titletoc with hyperref doesn't define \toclevel@...
%\def\toclevel@backchapter{0}%{0}% titletoc with hyperref doesn't define \toclevel@...

\bookmarksetup{%
  open,
  numbered,
  openlevel=2,% Bookmarks are opened up to sections (level=1), subsections (level=2), etc.
  depth=6,% subparagraph=6 / paragraph=5 / overparagraph=4 / subsubsection=3
  color=firstcolor,% OK for Adobe Reader but not for Evince
  %view={FitH - \calc{paperheight-\topmargin-1in}},
  addtohook={% OK for Adobe Reader but not for Evince
    \ifnum\bookmarkget{level}=-2 % book
      \bookmarksetup{bold, italic, color={black}}%
    \fi
    \ifnum\bookmarkget{level}=-1 % part
      \bookmarksetup{bold, italic, color={secondcolor}}%
    \fi
    \ifnum\bookmarkget{level}=0 % chapter
      \bookmarksetup{bold, color={firstcolor}}%
    \fi
    \ifnum\bookmarkget{level}=-5 % appendixchapter
      \bookmarksetup{bold, color={firstcolor}}%
    \fi
    \ifnum\bookmarkget{level}=-6 % backchapter
      \bookmarksetup{bold, color={firstcolor}}%
    \fi
  },
  addtohook={% https://tex.stackexchange.com/questions/156530/how-to-change-the-pdfbookmark-titles
    %- Change numbering layout of parts in bookmarks: ordinal to Roman
    \ifnum\toclevel@part=\bookmarkget{level}\relax
      %\bookmarksetup{bold,italic,color={secondcolor}}%
      \renewcommand*{\numberline}[1]{\Roman{part} \textemdash\space}%
    \fi
    %- Change numbering layout of chapters in bookmarks
    \ifnum\toclevel@chapter=\bookmarkget{level}\relax
      %\renewcommand*{\numberline}[1]{#1 \textendash{} }%
      \renewcommand*{\numberline}[1]{\arabic{chapter} \textendash\space}%
      %\renewcommand*{\numberline}[1]{\arabic{#1} \textendash{} }%
      %\renewcommand*{\numberline}[1]{Chapitre #1 \textendash{} }%
    \fi
    %- Change numbering layout of sections in bookmarks
    \ifnum\toclevel@section=\bookmarkget{level}\relax
      \renewcommand*{\numberline}[1]{\arabic{section}. }%
      %\renewcommand*{\numberline}[1]{#1 }%
    \fi
    %- Change numbering layout of subsections in bookmarks
    \ifnum\toclevel@subsection=\bookmarkget{level}\relax
      %\renewcommand*{\numberline}[1]{#1 }%
    \fi
    %- Change numbering layout of appendix chapter in bookmarks (as chapter)
    \ifnum\toclevel@appendixchapter=\bookmarkget{level}\relax
      %\bookmarksetup{rellevel=1}% Level relative to the previous one: value > 0 => child (here part)
      \bookmarksetup{level=0}% Wanted absolute level (here chapter)
      \renewcommand*{\numberline}[1]{\Alph{appendixchapter} \textendash\space}%
    \fi
    %- No numbering layout of back chapters − no star needed − in bookmarks
    \ifnum\toclevel@backchapter=\bookmarkget{level}\relax
      \bookmarksetup{level=0}% Wanted absolute level (here chapter)
      \renewcommand*{\numberline}[1]{}% No numbering at all
    \fi
  },
}
%\bookmarkdefinestyle{top}{% https://tex.stackexchange.com/questions/348044/ (H. Oberdiek answer)
%  level=0,
%  rawaction={%
%    /S/JavaScript%
%    /JS(event.target.open=!event.target.open)%
%  },
%}

%-- Detecting and applying an absolute referenced page number

%- As other packages by Heiko Oberdiek: essential and awesome!
%\RequirePackage{zref-user}% Already loaded (see above)
%\RequirePackage{zref-abspage}% Already loaded (see above)

%- Defining a new bookmark command referring to the absolute page number (Martin Scharrer)
%- https://tex.stackexchange.com/questions/11962/how-to-determine-current-page-number
\newcommand{\pagebookmark}[3][]{%
  \zlabel{#2}%
  \bookmark[page=\zref@extractdefault{#2}{abspage}{1},#1]{#3}%
}

%- Defining a new bookmark command referring to the absolute page number (Heiko Oberdiek)
%- https://tex.stackexchange.com/questions/67396/[...]
%-    [...]probem-with-bookmarks-and-linking-and-page-numbering/
\newcounter{zpage}
\renewcommand*{\thezpage}{pagelabel\the\value{zpage}}
\newcommand*{\linkpagebookmark}[2][]{%
  \stepcounter{zpage}%
  \zref@labelbyprops{\thezpage}{abspage}%
  \zref@refused{\thezpage}%
  \bookmark[{%
    page=\zref@extractdefault{\thezpage}{abspage}{1},%
    view={XYZ},%
    #1%
  }]{#2}%
}

%----- Setting correct bookmarks
%-------------------------------
%- See also:
%- From Heiko Oberdiek himself :
%-   https://tex.stackexchange.com/questions/67396/[...]
%-     [...]probem-with-bookmarks-and-linking-and-page-numbering
%-   https://tex.stackexchange.com/questions/81687/hyperref-generated-bookmarks-pointing-too-low
%-   https://tex.stackexchange.com/questions/116982/[...]
%-     situation-dependent-bookmark-level-of-subsubsection
%-   https://tex.stackexchange.com/questions/156530/how-to-change-the-pdfbookmark-titles-hyperref
%- From Christian Hupfer
%-   https://tex.stackexchange.com/questions/300099 (get-sections-with-no-numbers)
%- See also:
%-   https://tex.stackexchange.com/questions/58810/[...]
%-     [...]automatic-target-here-with-bookmark-as-with-pdfbookmark
%-   http://tex.stackexchange.com/questions/274212/correct-hierarchy-levels-of-pdf-bookmarks
%-   Warning: http://tex.stackexchange.com/questions/60209/how-to-add-an-extra-level-of-sections
%-   https://tex.stackexchange.com/questions/398143/creating-bookmarks-in-pdf-files
%-   http://tex.stackexchange.com/questions/318015/split-table-of-contents-on-part-page
%-   https://tex.stackexchange.com/questions/113132/[...]
%-     [...]change-format-of-hyperref-generated-pdf-bookmarks
%-   https://tex.stackexchange.com/questions/97024/[...]
%-     [...]how-to-add-the-pdf-bookmark-of-toc-without-its-name-contents-in-toc
%-----

%- Redefining/adding bookmarks taking into account an absolute page reference for parts, chapters...
%- https://tex.stackexchange.com/questions/113132/change-format-of-hyperref-generated-pdf-bookmarks
\def\Hy@writebookmark#1#2#3#4#5{% From 'bookmark.sty'
  \ifnum#4>\BKM@depth\relax
  \else
    \def\BKM@type{#5}%
    \ifx\BKM@type\Hy@bookmarkstype
      \begingroup
        \ifBKM@numbered
          \let\numberline\Hy@numberline
          \let\booknumberline\Hy@numberline
          \let\partnumberline\Hy@numberline
          \let\chapternumberline\Hy@numberline
        \else
          \let\numberline\@gobble
          \let\booknumberline\@gobble
          \let\partnumberline\@gobble
          \let\chapternumberline\@gobble
        \fi
        \ifnum#4<1% Part, chapter, appendixchapter, backchapter bookmarks
          \linkpagebookmark[level=#4]{#2}% Added
        \else
           \bookmark[level=#4,dest={#3}]{#2}% Original
         \fi
      \endgroup
    \fi
  \fi
}

%- Adding bookmarks in the PDF document, but not in the (printed) Table of Contents itself
\ifdoc@article\else
  %- Bookmark for the cover "title page"
  \pretocmd{\maketitle}{%
    %\pdfbookmark[-2]{\@doctitle}{titlebookmark}% Old fashion and wrong placement
    %\bookmark[level=-2,page=1]{\@doctitle}% No need of M. Scharrer's '\pageboomark' here
    \label{coverbookmark}
    \pagebookmark[level=-2]{coverbookmark}{\@doctitle}%
  }{}{}
  %- Bookmark for the table of contents
  \pretocmd{\tableofcontents}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\contentsname}{tdmbookmark}% Old fashion and wrong placement
    \label{tdmbookmark}
    \pagebookmark[level=0]{tdmbookmark}{\contentsname}%
  }{}{}
  %- Bookmark for the list of figures
  \pretocmd{\listoffigures}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listfigurename}{lofbookmark}% Old fashion and wrong placement
    \label{lofbookmark}
    \pagebookmark[level=0]{lofbookmark}{\listfigurename}%
  }{}{}
  %- Bookmark the list of tables
  \pretocmd{\listoftables}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listtablename}{lotbookmark}% Old fashion and wrong placement
    \label{lotbookmark}
    \pagebookmark[level=0]{lotbookmark}{\listtablename}%
  }{}{}
  %- Bookmark for the list of exercises
  \pretocmd{\listofexercises}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listexercisename}{loebookmark}% Old fashion and wrong placement
    \label{loebookmark}
    \pagebookmark[level=0]{loebookmark}{\listexercisename}%
   }{}{}%
  %- Bookmark for the list of quizzes
  \pretocmd{\listofquizzes}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listquizname}{loqbookmark}% Old fashion and wrong placement
    \label{loqbookmark}
    \pagebookmark[level=0]{loqbookmark}{\listquizname}%
   }{}{}%
  %- Bookmark for the list of videos
  \pretocmd{\listofvideos}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listvideoname}{lovbookmark}% Old fashion and wrong placement
    \label{lovbookmark}
    \pagebookmark[level=0]{lovbookmark}{\listvideoname}%
  }{}{}%
  %- Bookmark for the list of codes
  \pretocmd{\listofcodes}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listcodename}{locbookmark}% Old fashion and wrong placement
    \label{locbookmark}
    \pagebookmark[level=0]{locbookmark}{\listcodename}%
  }{}{}%
  %- Bookmark for the list of listings
  \pretocmd{\listoflistings}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listlistingname}{lolbookmark}% Old fashion and wrong placement
    \label{lolbookmark}
    \pagebookmark[level=0]{lolbookmark}{\listlistingname}%
  }{}{}%
  %- Bookmark for the list of documents
  \pretocmd{\listofdocuments}{%
    \if@openright\cleardoublepage\else\clearpage\fi%
    %\pdfbookmark[0]{\listdocumentname}{lodbookmark}% Old fashion and wrong placement
    \label{lodbookmark}
    \pagebookmark[level=0]{lodbookmark}{\listdocumentname}%
  }{}{}%
\fi


















\endinput








