%%
%% texjazz-common.def
%%
%% A LaTeX file to manage the general layout and structure of the document.
%%
%% Copyright (c) 2020-2021 ejazz.
%%
%---------------------------------------------------------------------------------------------------
% This work is part of the TeXjazz bundle. It may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% The Current Maintainer of this work is ejazz <ejazz.fr@gmail.com>.
%
% This work consists of the files:
%     `texjazz-common.def' and `texjazz-common[-fr].tex' (not yet fully available).
%---------------------------------------------------------------------------------------------------

%-- File identification
%----------------------

\ProvidesFile{texjazz-common}[2021/02/08 v0.1a − Structure of the document]

%-- Setting general layout
%-------------------------

%- Overall layout
\RequirePackage{geometry}

%- Provides commands/environment according to the page `side' (odd/even)
\RequirePackage[strict]{changepage}

%- Adds commands to put contents according to the current page `side'
\RequirePackage{ifoddpage}% Must be loaded *after* the `changepage' package

%- An analogue of minipage whose width is the natural width of its contents
\RequirePackage{varwidth}

%- Alignement du texte avec césures correctes
\RequirePackage{ragged2e}

%- Arranges marginpars "intelligently" / Automatically adjust the side material nicely
%\RequirePackage{marginfix}

%- LaTex3 implementation of sidenotes, for compatibility (clashes because we use same names commands)
%\RequirePackage{sidenotes}

%-- Effective layout application
%-------------------------------

%--- For the record:
%- inner/outer margins = 20mm, marginparwidth = 52mm, marginparsep=8mm,
%- textwidth = 110mm, fullwidth = 170mm
%---

\ifbool{doc@showframe}{%
%\ifdoc@showframe
  \geometry{%
    a4paper, twoside,
    top=27mm, bottom=27mm, inner=20mm, outer=20mm,
    ignorehead, ignorefoot, includemp,
    marginparwidth=52mm, marginparsep=8mm,
    headsep=7mm, headheight=12.2pt, footskip=14mm, showframe
  }
  }{%
%\else
  \geometry{%
    a4paper, twoside,
    top=27mm, bottom=27mm, inner=20mm, outer=20mm,
    ignorehead, ignorefoot, includemp,
    marginparwidth=52mm, marginparsep=8mm,
    headsep=7mm, headheight=12.2pt, footskip=14mm
  }
%\fi
}

%- Layout utility commands: changing the page layout mid-document
\newcommand{\symmetricalpage}{
  \newgeometry{%
    top=27mm, bottom=27mm, inner=20mm, outer=20mm,
    ignorehead, ignorefoot, includemp, nomarginpar,
    headsep=7mm, headheight=12.2pt, footskip=14mm,
  }
}
\newcommand{\appendixpage}{
  \newgeometry{%
    twoside,
    top=27mm, bottom=27mm, inner=20mm, outer=10mm,
    ignorehead, ignorefoot, includemp,
    marginparwidth=36mm, marginparsep=4mm,
    headsep=7mm, headheight=12.2pt, footskip=14mm
  }
}
\newcommand{\referencepage}{
  \newgeometry{%
    twoside,
    top=27mm, bottom=27mm, inner=20mm, outer=20mm,
    ignorehead, ignorefoot, includemp,
    marginparwidth=24mm, marginparsep=8mm,
    headsep=7mm, headheight=12.2pt, footskip=14mm
  }
}
\newcommand{\asymmetricalpage}{\restoregeometry}

%-- Creating new floats / Création de nouveaux flottants : video, etc.
%---------------------------------------------------------------------

%-- Floats inside text core: figure, table (and others with the 'newfloat' package below)

%- If the `float' package is used, the `wrapfig' package has to be loaded after the `float' package
%- and the both before declaring a newfloat type
\RequirePackage{wrapfig}

%----- Agencement des figures dans le corps de texte / Arrange figures and graphics in the text body
%- Syntax: \begin{wrapfigure}[12]{r}[34pt]{5cm}<figure>\end{wrapfigure}
%- [number of narrow lines]{placement}[overhang]{width}
%- If the text is less height than the figure, insert the whole in a group:
%- \begingroup <wrapfigure> <text sfuff> \vfill\endgroup (see doc. p.1 "idiosyncrasies #2")
%-----

\setlength{\intextsep}{0pt}% gap at the top and bottom: default=12.0pt plus 2.0pt minus 2.0pt
\setlength{\columnsep}{8pt}% gap between wrapped figure and the text: default=10pt
%\setlength{\wrapoverhang}{\marginparwidth}% figure in margin
%\addtolength{\wrapoverhang}{\marginparsep}

%-- New floating environments (with the `newfloat' package, part of the `caption' bundle)

\RequirePackage{newfloat}% Helper package

%- New floats

\DeclareFloatingEnvironment[% Graphic environment
  name=graphic,
  placement=hbt,
  within=none,
]{graphic}

\ifdoc@article
  \DeclareFloatingEnvironment[% Video environment
    fileext=lov,
    listname={List of Videos},
    name=video,
    placement=hbt,
    within=none,%section
  ]{video}
\else
  \DeclareFloatingEnvironment[% Video environment
    fileext=lov,
    listname={List of Videos},
    name=video,
    placement=hbt,
    within=chapter,
  ]{video}
\fi

%- Default placement of floats (figures and tables are already defined by article and book classes)

\SetupFloatingEnvironment{figure}{placement=hbt}
\SetupFloatingEnvironment{table}{placement=hbt}
\SetupFloatingEnvironment{graphic}{placement=hbt}

%----- Allowing more floats processing (default maximum = 18 floats)
%- The use of the `morefloats' package is no more usefull, because the new eTeX kernel (> 2015/01)
%- controls the extended allocation mechanism (see egreg's answer referenced below).
%- Cf. http://tex.stackexchange.com/questions/38607/no-room-for-a-new-dimen/38609#38609
%- Older ref.: http://tex.stackexchange.com/questions/1650/[...]
%-   [...]too-many-unprocessed-floats-with-marginpar
%-----

\extrafloats{500}% Maximum of float processings (up to 256?)

%-- Placement et rotation des flottants / Floats placing and rotating
%--------------------------------------------------------------------

%----- Several solutions
%- 0. placeins.sty -> keeps floats ‘in their place’, preventing them from floating past
%-     a “\FloatBarrier” command into another section. To use it, insert “\FloatBarrier”
%-     at places that floats should not move past, perhaps at every “\section”.
\RequirePackage{placeins}
%- 1. float.sty -> creation et placement de nouveaux flottants (option H pour HERE expressement,
%-     incompatible avec les options hbtp des flottants natifs LaTeX)
%\RequirePackage{float}
%- 2. afterpage.sty -> put instructions after the current page like: \afterpage{\clearpage}
\RequirePackage{afterpage}
%- 3. rotating.sty -> rotation d'objets et rotfloat.sty -> rotation de flottants
%\RequirePackage{rotating}
%\RequirePackage{rotfloat}
%- 4. floatrow.sty -> inclut le code de base de float.sty/rotfloat.sty et propose d'autres
%-     fonctionnalités comme le placement des légendes, notamment dans la marge (doc très confuse)
%\RequirePackage{floatrow}% Incompatible avec float.sty et rotfloat.sty car fonctionnalités incluses
%\floatsetup{margins=hangleft,capposition=beside,
%            capbesideposition={top,left},floatwidth=\textwidth}
%-----

%---- New "non floating" environments / Nouveaux environments « fixes » : figure, table, etc.
%---------------------------------------------------------------------------------------------------

%-- All the following environments are defined to easily and automatically detect their presence
%-- and for assigning their caption in their respectve "List of..." (see below)

%-- Fixed "figure-like" environment

\NewDocumentEnvironment{jazzfigure}{  }
  {\captionsetup{type=figure}}{}

\NewDocumentEnvironment{jazzfigure*}{  }
  {\begin{fullwidth}\captionsetup{type=figure}}%
  {\end{fullwidth}}

%-- Fixed "table-like" environment

\NewDocumentEnvironment{jazztable}{  }
  {\captionsetup{type=table}}{}

\NewDocumentEnvironment{jazztable*}{  }
  {\begin{fullwidth}\captionsetup{type=table}}%
  {\end{fullwidth}}

%-- Fixed "code-like" environment

\NewDocumentEnvironment{jazzcode}{  }
  {\captionsetup{type=code}}{}

\NewDocumentEnvironment{jazzcode*}{  }
  {\begin{fullwidth}\captionsetup{type=code}}%
  {\end{fullwidth}}

%-- Fixed "listing-like" environment

\NewDocumentEnvironment{jazzlisting}{  }
  {\captionsetup{type=listing}}{}

\NewDocumentEnvironment{jazzlisting*}{  }
  {\begin{fullwidth}\captionsetup{type=listing}}%
  {\end{fullwidth}}

%-- Fixed "graphic-like" environment

\NewDocumentEnvironment{jazzgraphic}{  }
  {\captionsetup{type=graphic}}{}

\NewDocumentEnvironment{jazzgraphic*}{  }
  {\begin{fullwidth}\captionsetup{type=jazzgraphic}}%
  {\end{fullwidth}}

%---- Document localization language / Francisation du document
%---------------------------------------------------------------------------------------------------

%-- Choix du système utilisé / Language system in use

%----- Important note
%- As for TeXLive 2019, the `polyglossia` package v.1.44 leads to compilation errors for French
%- spaced ponctuation, like ; : ! ? and guillemets « ». This was not the case with the 2018 release
%- V.1.43 (please note that they seem to be the same after a comparison beetween the two releases).
%- Because with LuaLaTeX, it seems that the `babel' package give better results we go back and
%- use this latter.
%-----

% If French typessetting system is Babel French (seems to be better with BibLaTeX: TeXSE)
%- Attention ! Les caractères rendus actifs par babel-french (;:!?) peuvent perturber certaines
%- extensions, c’est le cas de tikz, xcolor, cleveref par exemple. Voir solutions : doc. §6.
%-- New names and/or explicitly redefining names
\ifbool{doc@english}{%
  \RequirePackage[french, english]{babel}%
  \selectlanguage{english}
  %\renewcommand{\codename}{Code}% \renewcommand if already defined with the 'newfloat' package
  %\renewcommand{\listingname}{Listing}% \renewcommand if already defined with 'minted'
  \newcommand{\documentname}{Document}
  \newcommand{\exercisename}{Exercise}
  \newcommand{\quizname}{Quiz}
  \renewcommand{\videoname}{Video}% Already defined with the 'newfloat' package
  %\renewcommand{\listcodename}{List of Codes}% \renewcommand if already defined with 'newfloat'
  %\renewcommand{\listlistingname}{List of Listings}% \newcommand because not defined by 'minted'
  \newcommand{\listdocumentname}{List of Documents}
  \newcommand{\listexercisename}{List of Exercises}
  \newcommand{\listquizname}{List of Quizzes}
  \renewcommand{\listvideoname}{List of Videos}% Already defined with the 'newfloat' package
}{\RequirePackage[english, french]{babel}%
  \selectlanguage{french}
  \renewcommand{\frenchlistfigurename}{Liste des figures}% Default = Table des figures! Ugly!
  %\renewcommand{\codename}{Code}% \renewcommand if already defined with the 'newfloat' package
  %\renewcommand{\listingname}{Listing}% \renewcommand if already defined with 'minted'
  \newcommand{\documentname}{Document}
  \newcommand{\exercisename}{Exercice}
  \newcommand{\quizname}{Quiz}
  \renewcommand{\videoname}{Vidéo}% Already defined with the 'newfloat' package
  %\renewcommand{\listcodename}{Liste des codes}% \renewcommand if already defined with 'newfloat'
  %\renewcommand{\listlistingname}{Liste des listings}% \newcommand if not defined by 'minted'
  \newcommand{\listdocumentname}{Liste des documents}
  \newcommand{\listexercisename}{Liste des exercices}
  \newcommand{\listquizname}{Liste des questionnaires}
  \renewcommand{\listvideoname}{Liste des vidéos}% Already defined with the 'newfloat' package
}

%-- Textsuperscript : \up, \ieme... from French Babel do not work fine (cf. `realscript' and doc.)

\newcommand{\frup}[1]{\textsuperscript{#1}}

%-- Guillemets, citation, ellipse, exergue

%- We explicity load here the `fvextra' package to avoid warnings from the `lineno' package
%- (these are used by the `minted' package and `fvextra' must be loaded before `csquotes' package)
\RequirePackage{fvextra}% several extensions and internal patchs to the `fancyvrb' package

\RequirePackage[autostyle=true]{csquotes}% Provides facilities for inline and display quotations
\ifdoc@english\else
  \setquotestyle[guillemets]{french}
\fi

%-- Nombres avec espacement et séparateur en fonction de la langue

\RequirePackage[autolanguage]{numprint}% (default=german=french OK)
%- Usage: \numprint[N/mm^2]{-123456}
%\newcommand*\npunitcommand[1]{\ensuremath{\mathrm{#1}}}% Original
\renewcommand*\npunitcommand[1]{\ensuremath{\mathsfup{#1}}}% to select text fonts

%- Séparateur des nombres décimaux en français (virgule), voir
%-    https://tex.stackexchange.com/questions/344953/using-decimal-numbers-with-systeme-package
\RequirePackage{siunitx}
\sisetup{output-decimal-marker={,}}% Usage: \num{1.5} or \num{1,5}

%-- Gestion des dates

%\RequirePackage{datetime2}% provides advanced features for managing and printing date and time

\ifbool{doc@english}{%
  \newcommand{\monthThreeLetterName}{%
    \ifcase\the\month
      \or Jan% 1
      \or Feb% 2
      \or Mar% 3
      \or Apr% 4
      \or May% 5
      \or Jun% 6
      \or Jul% 7
      \or Aug% 8
      \or Sep% 9
      \or Oct% 10
      \or Nov% 11
      \or Dec% 12
    \fi
  }
}{\newcommand{\monthThreeLetterName}{%
    \ifcase\the\month
      \or Jan% 1
      \or Fév% 2
      \or Mar% 3
      \or Avr% 4
      \or Mai% 5
      \or Jui% 6
      \or Jul% 7
      \or Aou% 8
      \or Sep% 9
      \or Oct% 10
      \or Nov% 11
      \or Déc% 12
    \fi
  }%
}
%\DTMnewdatestyle{dayNumberOnTwoDigit}{%
%  %\renewcommand*{\DTMdisplaydate}[4]{\DTMtwodigit{##3}-\DTMtwodigits{##2}-##1}%
%  \renewcommand*{\DTMdisplaydate}[4]{\DTMtwodigits{##3}}%
%  \renewcommand*{\DTMDisplaydate}{\DTMdisplaydate}
%  %\DTMtwodigit{\THEDAY}
%}
%\AtBeginDocument{\let\today\DTMtoday}


%---------------------------------------------------------------------------------------------------
%---- New macros and elements: commands/environments/shortcuts
%---------------------------------------------------------------------------------------------------

%-- Referenced document elements
%-------------------------------

%\newcounter{video}% Already defined by `newfloat'
%\renewcommand{\thevideo}{\thechapter.\arabic{video}}
\newcounter{document}
\renewcommand{\thedocument}{\thechapter.\arabic{document}}

%---
%- https://tex.stackexchange.com/questions/35310/problem-with-use-of-in-custom-href-command
%- https://tex.stackexchange.com/questions/208808/newcommand-with-href
%- TAKE CARE that new commands based on \href break the absortion of special characters like # or ~
%---

%- For the record, general approach
%\newcommand*{\link}{\begingroup\@makeother\#\@mylink}
%\newcommand*{\@mylink}[2]{\href{#1}{\underline{#2}}\endgroup}

\newcommand{\videolink}{%
  \refstepcounter{video}%
  \begingroup\@makeother\#\@videolink%
}
\newcommand{\@videolink}[3][\faVideoCamera]{%
  \textcolor{secondcolor}{\normalfont\small\faVideoCamera\space}%
  \textsc{\small Vidéo\space\thevideo\space\textcolor{secondcolor}{\textemdash}\space}%
  \href{run:#2}{#3}\endgroup%
  %\addcontentsline{lov}{video}{%
  %  \protect\numberline{\thevideo}#3\enspace\textcolor{secondcolor}{\normalfont\small#1}%
  \addcontentsline{lov}{video}{%
    \protect\numberline{\thevideo}#3\enspace\textcolor{secondcolor}{\normalfont\footnotesize#1}%
  }%
}
\newcommand{\sidevideolink}{%
  \refstepcounter{video}%
  \begingroup\@makeother\#\@sidevideolink%
}
\newcommand{\@sidevideolink}[3][\faVideoCamera]{%
  \textcolor{secondcolor}{\normalfont\footnotesize\faVideoCamera}%
  \textsc{\footnotesize\enspace Vid.\space%
    \thevideo\space\textcolor{secondcolor}{\textemdash}\space}%
  \href{run:#2}{#3}\endgroup%
  \addcontentsline{lov}{video}{%
    \protect\numberline{\thevideo}#3\enspace\textcolor{secondcolor}{\normalfont\footnotesize#1}%
  }%
}
\newcommand*{\textdoc}{%
  \refstepcounter{document}%
  \begingroup\@makeother\#\@textdoc%
}
\newcommand*{\@textdoc}[3][\faFileTextO]{%
  \href{run:#2}{\textcolor{secondcolor}{\normalfont\faFileTextO} #3}\endgroup%
  \addcontentsline{lod}{document}{%
    \protect\numberline{\thedocument}#3\enspace\textcolor{secondcolor}{\normalfont\small#1}%
  }%
}
\newcommand*{\pdfdoc}{%
  \refstepcounter{document}%
  \begingroup\@makeother\#\@pdfdoc%
}
\newcommand*{\@pdfdoc}[3][\faFilePdfO]{%
  \href{run:#2}{\textcolor{secondcolor}{\normalfont\faFilePdfO} #3}\endgroup%
  \addcontentsline{lod}{document}{%
    \protect\numberline{\thedocument}#3\enspace\textcolor{secondcolor}{\normalfont\small#1}%
  }%
}
\newcommand*{\pdfwatch}{%
  \refstepcounter{document}%
  \begingroup\@makeother\#\@pdfwatch%
}
\newcommand*{\@pdfwatch}[4][\faFilePdfO]{%
  \href{run:#2}{#3}\endgroup%
  \addcontentsline{lod}{document}{%
    \protect\numberline{\thedocument}#4\enspace\textcolor{secondcolor}{\normalfont\small#1}%
  }%
}
\newcommand{\pdflink}[1]{%
  \href{run:#1}{\textcolor{secondcolor}{\normalfont\faFilePdfO}}%
}
\newcommand*{\webdoc}{%
  \refstepcounter{document}%
  \begingroup\@makeother\#\@webdoc%
}
\newcommand*{\@webdoc}[3][\faFirefox/\faExternalLink]{%
  %\href{#2}{\textcolor{secondcolor}{\normalfont\faExternalLink} #3}\endgroup%
  \href{#2}{\textcolor{secondcolor}{\normalfont #1} #3}\endgroup%
  %\ifemptyarg{#1}
  %  {\addcontentsline{lod}{document}{\protect\numberline{\thedocument}#3}}%
    {\addcontentsline{lod}{document}{%
      \protect\numberline{\thedocument}#3\enspace\textcolor{secondcolor}{\normalfont\small#1}}%
    }%
}
\newcommand*{\hrefdoc}{%
  \refstepcounter{document}%
  \begingroup\@makeother\#\@hrefdoc%
}
\NewDocumentCommand{\@hrefdoc}{O{\faFirefox} d<> m m}{%
  \href{#3}{#4}\endgroup%
  \IfValueTF{#2}
    {\addcontentsline{lod}{document}{%
      \protect\numberline{\thedocument}#2\enspace\textcolor{secondcolor}{\normalfont\small#1}}%
    }
    {\addcontentsline{lod}{document}{%
      \protect\numberline{\thedocument}#4\enspace\textcolor{secondcolor}{\normalfont\small#1}}%
    }%
}

\endinput





