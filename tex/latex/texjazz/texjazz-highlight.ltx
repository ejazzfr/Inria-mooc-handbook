%%
%% texjazz-highlight.ltx
%%
%% A LaTeX file to configure highlighted commands and environments.
%%
%% Copyright (c) 2020-2021 ejazz.
%%
%---------------------------------------------------------------------------------------------------
% This work is part of the TeXjazz bundle. It may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% The Current Maintainer of this work is ejazz <ejazz.fr@gmail.com>.
%
% This work consists of the files:
%     `texjazz-highlight.ltx' and `texjazz-highlight[-fr].tex' (not yet fully available).
%---------------------------------------------------------------------------------------------------

%-- File identification
%----------------------

\ProvidesFile{texjazz-highlight.ltx}%
  [2021/02/08 v0.1a − Inserting highlighted remarks, notes and environments]

%-- Utilities

%\RequirePackage{xparse}% LaTeX3 syntax parser for LaTeX2e to define advanced commands/environments
%\RequirePackage{etoolbox}% Swiss knife!
%\RequirePackage{pgfkeys}% Key-value options management for commands and environments
%\RequirePackage{pgfopts}% Key-value options for packages and classes

%\RequirePackage{xcolor}% Color management
%\RequirePackage{tikz}% Graphics amazing tool
%\usetikzlibrary{backgrounds, calc, fpu, chains, fit, positioning, 
%                shapes, shadings, decorations.pathmorphing}
%\RequirePackage{tikzpagenodes}% Extended page nodes
%\RequirePackage{tcolorbox}% Fancy efficient coloured boxes (load needed TikZ libraries)
%\tcbuselibrary{breakable, fitting, raster, skins, theorems, xparse, hooks}
%\RequirePackage{fontawesome5}% Nice and useful symbols
%\RequirePackage{fontawesome}% Fontawesome v4.6: to be loaded *after* v.5.x to override definitions

%\RequirePackage{marginnote}% Managing margin elements
\RequirePackage{calc}%
\RequirePackage{textcase}%

\RequirePackage{atbegshi}
\RequirePackage{cancel}
\RequirePackage{soul}
%\RequirePackage{soulutf8}
%\RequirePackage{soulpos}% by Javier Bezos (TODO: see doc. in order to use it, may be better way)

%-- Options
%----------

\newbool{highlight@usefrenchlanguage}% To be extended for compliance with language packages
\booltrue{highlight@usefrenchlanguage}

%- The "titlingfont" comes from textjazz-handbook and texjazz-doc classes
\ifcsdef{titlingfont}{}{\let\titlingfont\bfseries}

%- The "boxtitlefont" comes from textjazz-handbook
\ifcsdef{boxtitlefont}{}{\let\boxtitlefont\sffamily}

%- The "lightboldfont" comes from textjazz-handbook
\ifcsdef{lightboldfont}{}{\let\lightboldfont\bfseries}

%- The "titlingspacedfont" comes from textjazz-handbook
\ifcsdef{titlingspacedfont}{}{\let\titlingspacedfont\sffamily}

%- The "tracked" font comes from textjazz-handbook
\ifcsdef{tracked}{}
  {\newcommand{\tracked}[1]{{\addfontfeature{LetterSpace=14}#1}}}

\DeclareRobustCommand{\spacedlowsmallcaps}[1]{%
  \textsc{\tracked{\titlingspacedfont\MakeTextLowercase{#1}}}%
}

\definecolor{darkelectricblue}{RGB}{83, 104, 120}% HTML: #536878 - CMYK: 31, 13, 0, 53
\definecolor{redbrown}{RGB}{153, 25, 25}% #991919ff
\definecolor{teal}{RGB}{0, 128, 128}% medium-satured blue-green
\definecolor{chocolate}{RGB}{183, 141, 94}% 
\definecolor{darkchocolate}{RGB}{113, 63, 14}% 

\definecolor{middlegrey}{gray}{.75}

\colorlet{boxbackgroundcolor}{black!10}
\colorlet{maincolor}{darkgray}
%\colorlet{maincolor}{linuxblue}
\colorlet{firstcolor}{darkelectricblue}
\colorlet{secondcolor}{redbrown}
\colorlet{thirdcolor}{teal}
\colorlet{fourthcolor}{chocolate}
\colorlet{framecolor}{darkelectricblue}

\colorlet{highlightcolor}{darkelectricblue}
\sethlcolor{yellow}

%- See: https://tex.stackexchange.com/questions/49832/[...]
%-        [...]highlighting-arbitrary-chunks-of-text-connected-to-quotes-in-margins-can-this
%-- Corrected code for `soul' package
%- From: http://tex.stackexchange.com/questions/48501/soul-broken-highlighting-with-xcolor
\newdimen\SOUL@dimen %new
\def\SOUL@ulunderline#1{{%
  \setbox\z@\hbox{#1}%
  \SOUL@dimen=\wd\z@ %new
  \dimen@i=\SOUL@uloverlap
  \advance\SOUL@dimen2\dimen@i %\dimen@ exchanged too
  \rlap{%
    \null
    \kern-\dimen@i
    \SOUL@ulcolor{\SOUL@ulleaders\hskip\SOUL@dimen}% new
  }%
  \unhcopy\z@
}}

%-- Coloured paragraph shortcuts
\newcommand{\emphpar}[2][]{% colored background, optional margin stuff (symbol, icon)
  \ifemptyarg{#1}
    {\setlength{\fboxsep}{1pt}\fcolorbox{firstcolor!25!white}{firstcolor!25!white}{%
      \parbox{\dimexpr \linewidth-2\fboxsep-2\fboxrule}{#2}}}
    {\llap{\textcolor{firstcolor}{#1}~}%
    %{\vskip\parskip\llap{\textcolor{firstcolor}{#1}~}\vspace{-3\parskip}%
      \fcolorbox{firstcolor}{firstcolor!25!white}{%
        \parbox{\dimexpr \linewidth-2\fboxsep-2\fboxrule}{#2}}}%
}

%\def\SOUL@hlpreamble{%
%    \setul{}{3.5ex}% increased by 1ex
%    \let\SOUL@stcolor\SOUL@hlcolor
%    \dimen@\SOUL@ulthickness
%    \dimen@i=-.75ex % increased by -0.25ex
%    \advance\dimen@i-.5\dimen@
%    \edef\SOUL@uldepth{\the\dimen@i}%
%    \let\SOUL@ulcolor\SOUL@stcolor
%    \SOUL@ulpreamble
%}
%\newcommand{\boxemph}[1]{{\hl{~#1~}}}
%\newcommand{\codebox}[1]{{\ttfamily\hyphenchar\font=45\relax\hl{~#1~}}}

\newcommand\jazztikzmark[1]{%
  \tikz[remember picture,overlay]\node[inner xsep=0pt,outer sep=0pt] (#1) {};}

\newcommand\marktext[3][6mm]{%
  \marginnote{%
    \jazztikzmark{e}\color{secondcolor}\footnotesize\itshape#3%
  }[#1]%
  \jazztikzmark{s}\hl{#2}
  \begin{tikzpicture}[remember picture, overlay]
  \draw[secondcolor] let \p1=(s), \p2=(e) in ($(\x2,\y1)-(\marginparsep,0)$) -- (e);
  \end{tikzpicture}%
}


%-- Souligner du texte avec césure (\underline tjrs disponible en mode math)

\RequirePackage[normalem]{ulem}% Mises en exergue étendues (sans redéfinir \emph{})

% Commandes :  \uline{important}=underline + \uuline{urgent}=double-underline
%  + \uwave{boat}=wavy-underline +  \sout{wrong}=line through words + \xout{removed}=marked-over
%   + \dashuline{dashing}=dashed underline + \dotuline{dotty}=dotted underline
%- TODO: Définir des commandes \uemph{}, \uuemph{}, \delword{}, etc.


\newcommand{\highlightenvsymbol}{}
\newlength{\highlightenvsymbolheight}
\newlength{\highlightenvsymbolwidth}


\NewTColorBox{remark}{ o g D<>{\faEye}}{% 
  % Syntax − #1 = more options; #2 = optional title, #3 = <symbol>
  code={%
    \renewcommand{\highlightenvsymbol}{\normalfont#3}
    \settowidth{\highlightenvsymbolwidth}{\normalfont\large\highlightenvsymbol}
    \settowidth{\highlightenvsymbolheight}{\normalfont\large\highlightenvsymbol}
  },
  enhanced jigsaw,
  breakable, parbox=false,
  colframe=framecolor, colback = boxbackgroundcolor!0,
  colbacktitle=framecolor!50!white,% initially=black!50!white
  bottomtitle=2pt, toptitle=2pt,% default=0pt
  boxrule = 0.6pt, boxsep = 0pt,% default=1mm
  %left=4pt, top=2pt,
  left = 4pt, right = 4pt,% additional to boxsep, default=4mm
  top = 4pt, bottom = 4pt,% default=2mm
  arc = 2pt,% outer arc = 0pt,
  IfValueTF={#2}{%
    adjusted title={#2},%{\hspace{10pt}{#1}},
    fonttitle=\normalsize\titlingfont,%\lightboldfont,%\sffamily\bfseries,
    halign title=flush left,%flush center,
    colbacktitle=black!65,%\@titlingcolor,% initially=black!50!white
    coltitle=white,%\@layoutcolor!0,% default=white
  }{},
  %beforeafter skip=4pt,
  ignore nobreak=true,% In case it follows a heading. Must be set with `before' (see doc p.79)
  before={%
    \vspace{4pt}%
    \par\pagebreak[0]\parindent=0pt% Default autoparskip option (see doc. §4.14 p.81)
    %\vspace{4pt}%
  },
  after skip=4pt,
  overlay={%
    %\node[xshift=(-0.5\envsymbolwidth-4pt)]
    %  at (frame.west) {\textcolor{askreplysecondcolor}{\normalfont\large\envsymbol}};
    \node[xshift=-10pt, yshift=-0.5\highlightenvsymbolheight, inner sep=0pt] 
      at (frame.north west) {% 10pt = 0.5*16pt + 2pt
      \textcolor{firstcolor}{\makebox[16pt][c]{\normalfont\large\highlightenvsymbol}}};
  },
  IfValueTF={#1}{#1}{},
}

\NewTColorBox{warnenv}{ o g }{% optional args: #1 = more options list ; #2 = title
  colframe=framecolor, colback = boxbackgroundcolor!0,
  colbacktitle=framecolor!50!white,% initially=black!50!white
  enhanced jigsaw,
  breakable, parbox=false,
  bottomtitle=2pt, toptitle=2pt,% default=0pt
  boxrule = 0.6pt, boxsep = 0pt,% default=1mm
  %left=4pt, top=2pt,
  left = 4pt, right = 4pt,% additional to boxsep, default=4mm
  top = 4pt, bottom = 4pt,% default=2mm
  arc = 2pt,% outer arc = 0pt,
  IfValueTF={#1}{%
    adjusted title={#1},%{\hspace{10pt}{#1}},
    fonttitle=\normalsize\titlingfont,%\lightboldfont,%\sffamily\bfseries,
    halign title=flush left,%flush center,
    colbacktitle=black!65,%\@titlingcolor,% initially=black!50!white
    coltitle=white,%\@layoutcolor!0,% default=white
  }{},
  %beforeafter skip=4pt,
  ignore nobreak=true,% In case it follows a heading. Must be set with `before' (see doc p.79)
  before={\vspace{\parskip}\llap{\textcolor{framecolor}{\faExclamationTriangle}~}\vspace{-\baselineskip}},
  after skip=2.5\parskip,
  IfValueTF={#2}{#2}{},
}
\NewTColorBox{questionenv}{ o g }{% optional args: #1 = more options list, title ; #2  breakable,
  colframe=framecolor, colback = boxbackgroundcolor!0,
  colbacktitle=framecolor!50!white,% initially=black!50!white
  enhanced jigsaw,
  breakable, parbox=false,
  bottomtitle=2pt, toptitle=2pt,% default=0pt
  boxrule = 0.6pt, boxsep = 0pt,% default=1mm
  %left=4pt, top=2pt,
  left = 4pt, right = 4pt,% additional to boxsep, default=4mm
  top = 4pt, bottom = 4pt,% default=2mm
  arc = 2pt,% outer arc = 0pt,
  IfValueTF={#2}{%
    adjusted title={#2},%{\hspace{10pt}{#1}},
    fonttitle=\normalsize\titlingfont,%\lightboldfont,%\sffamily\bfseries,
    halign title=flush left,%flush center,
    colbacktitle=black!65,%\@titlingcolor,% initially=black!50!white
    coltitle=white,%\@layoutcolor!0,% default=white
  }{},
  %beforeafter skip=4pt,
  ignore nobreak=true,% In case it follows a heading. Must be set with `before' (see doc p.79)
  before={\vspace{4pt}\llap{\textcolor{framecolor}{\faQuestionCircle}~}\vspace{-\baselineskip}},
  after skip=4pt,
  IfValueTF={#1}{#1}{},
}
\NewTColorBox{infoenv}{ o g }{% optional args: #1 = more options list ; #2 = title
  colframe=framecolor, colback = boxbackgroundcolor!0,
  colbacktitle=framecolor!50!white,% initially=black!50!white
  enhanced jigsaw,
  breakable, parbox=false,
  bottomtitle=2pt, toptitle=2pt,% default=0pt
  boxrule = 0.6pt, boxsep = 0pt,% default=1mm
  %left=4pt, top=2pt,
  left = 4pt, right = 4pt,% additional to boxsep, default=4mm
  top = 4pt, bottom = 4pt,% default=2mm
  arc = 2pt,% outer arc = 0pt,
  IfValueTF={#2}{%
    adjusted title={#2},%{\hspace{10pt}{#1}},
    fonttitle=\normalsize\titlingfont,%\lightboldfont,%\sffamily\bfseries,
    halign title=flush left,%flush center,
    colbacktitle=black!65,%\@titlingcolor,% initially=black!50!white
    coltitle=white,%\@layoutcolor!0,% default=white
  }{},
  %beforeafter skip=4pt,
  ignore nobreak=true,% In case it follows a heading. Must be set with `before' (see doc p.79)
  before={\vspace{\parskip}\llap{\textcolor{framecolor}{\faInfoCircle}~}\vspace{-\baselineskip}},
  after skip=2.5\parskip,
  IfValueTF={#1}{#1}{},
}

%-- Extended code for two-side documents (http://tex.stackexchange.com/questions/78193/)

\newcounter{jazzcautioncnt}
\newlength\jazztrianglexshift
\newlength\jazzboxhshift
\newlength\jazzboxvshift
\newlength\jazznoteheight
\newlength\jazzuppertrianglecorner
\newcommand\jazzside{}
\newcommand\jazzotherside{}
\newcommand\jazzboxanchor{}
\newcommand\jazzpointeranchor{}

\newcommand\cautiontikzmark[1]{%
  \tikz[remember picture,overlay]\node[inner xsep=0pt,outer sep=0pt] (#1) {};}

\NewDocumentCommand{\caution}{O{c} D<>{firstcolor} m G{\defaultcautionboxname}}{%
  \checkoddpage
  \ifoddpageoroneside
    \setlength\jazztrianglexshift{-3pt}%
    \setlength\jazzboxhshift{\marginparsep}%
    \renewcommand{\jazzside}{west}%
    \renewcommand{\jazzotherside}{east}%
  \else
    \setlength\jazztrianglexshift{3pt}%
    \setlength\jazzboxhshift{-\marginparsep}%
    \renewcommand{\jazzside}{east}%
    \renewcommand{\jazzotherside}{west}%
  \fi%
  \settoheight{\jazznoteheight}{\parbox{\marginparwidth-8pt}{\footnotesize#3}}%
  \stepcounter{jazzcautioncnt}%
  \cautiontikzmark{\thejazzcautioncnt}%
  \if#1b\relax
    \renewcommand\jazzpointeranchor{xcautionbox\thejazzcautioncnt.south \jazzside}%
    \renewcommand\jazzboxanchor{south \jazzside}%
    \setlength\jazzboxvshift{\jazznoteheight}%
    \addtolength\jazzboxvshift{-.6\baselineskip}% Adjust the vertical shift with the text line
    \setlength\jazzuppertrianglecorner{13pt}%
  \else
    \if#1t\relax
      \renewcommand\jazzpointeranchor{xcautionbox\thejazzcautioncnt.north \jazzside}%
      \renewcommand\jazzboxanchor{north \jazzside}%
      \setlength\jazzboxvshift{-\jazznoteheight}%
      \addtolength\jazzboxvshift{.6\baselineskip}% Adjust the vertical shift with the text line
      \setlength\jazzuppertrianglecorner{-7pt}%
    \else
      \if#1c\relax
        \renewcommand\jazzpointeranchor{xcautionbox\thejazzcautioncnt.\jazzside}%
        \renewcommand\jazzboxanchor{\jazzside}%
        %\setlength\jazzboxvshift{\baselineskip}% No vertical shift, just centered with the text line
        \setlength\jazzuppertrianglecorner{3pt}%
      \fi%
    \fi%
  \fi%
  %- To avoid overlapings between with \sidenote the tikzpicture itself is wrapped into a \sidenote
  %- inside the definition of \caution and the numbering must be disabled, see:
  %- https://tex.stackexchange.com/questions/258437/[...]
  %-   [...]prevent-overlap-in-margins-by-blocking-some-vertical-space
  \marginnote{%
    \begin{tikzpicture}[remember picture, overlay]%
      \node[draw=#2,thick,anchor=\jazzside,xshift=\jazzboxhshift,yshift=\jazzboxvshift,inner sep=4pt]
        (xcautionbox\thejazzcautioncnt)
        at ([yshift=3pt]current page text area.\jazzotherside|-\thejazzcautioncnt)
        {\parbox{\marginparwidth-8pt}{\vskip4pt\footnotesize#3\vskip2pt}};
        %{\parbox{\marginparwidth}{\vskip10pt\RaggedRight\small#3}};
      \node[fill=white,font=\color{#2}\sffamily,anchor=west,inner sep=2pt,xshift=7pt,yshift=0pt]
        at (xcautionbox\thejazzcautioncnt.north west)
        {\footnotesize\enspace\textcolor{black}{\textsc{#4}}\enspace};
      \fill[#2]
        ([yshift=\jazzuppertrianglecorner]\jazzpointeranchor) --
        ([yshift=\jazzuppertrianglecorner-3pt,xshift=\jazztrianglexshift]\jazzpointeranchor) --
        ([yshift=\jazzuppertrianglecorner-6pt]\jazzpointeranchor) -- cycle;
    \end{tikzpicture}%
  }%
  %\endgroup
}

\newcommand{\defaultcautionboxname}{}
\ifbool{highlight@usefrenchlanguage}
  {\renewcommand{\defaultcautionboxname}{Attention !}}
  {\renewcommand{\defaultcautionboxname}{Caution!}}

\newcounter{cautioncount}
\NewDocumentCommand{\cautionright}{ O{c} D<>{firstcolor} m G{\defaultcautionboxname} }{%
  \setlength\jazztrianglexshift{-3pt}%
  \setlength\jazzboxhshift{\marginparsep}%
  \renewcommand{\jazzside}{west}%
  \renewcommand{\jazzotherside}{east}%
  \settoheight{\jazznoteheight}{\parbox{\marginparwidth-8pt}{\footnotesize#3}}%
  \stepcounter{cautioncount}%
  \jazztikzmark{\thecautioncount}%
  \if#1b\relax
    \renewcommand\jazzpointeranchor{cautionbox\thecautioncount.south \jazzside}%
    \renewcommand\jazzboxanchor{south \jazzside}%
    \setlength\jazzboxvshift{\jazznoteheight}%
    \addtolength\jazzboxvshift{-.6\baselineskip}% Adjust the vertical shift with the text line
    \setlength\jazzuppertrianglecorner{13pt}%
  \else
    \if#1t\relax
      \renewcommand\jazzpointeranchor{cautionbox\thecautioncount.north \jazzside}%
      \renewcommand\jazzboxanchor{north \jazzside}%
      \setlength\jazzboxvshift{-\jazznoteheight}%
      \addtolength\jazzboxvshift{.6\baselineskip}% Adjust the vertical shift with the text line
      \setlength\jazzuppertrianglecorner{-7pt}%
    \else
      \if#1c\relax
        \renewcommand\jazzpointeranchor{cautionbox\thecautioncount.\jazzside}%
        \renewcommand\jazzboxanchor{\jazzside}%
        %\setlength\jazzboxvshift{\baselineskip}% No vertical shift, just centered with the text line
        \setlength\jazzuppertrianglecorner{3pt}%
      \fi%
    \fi%
  \fi%
  \marginnote{%
    \begin{tikzpicture}[remember picture, overlay]
      \node[draw=#2, thick, anchor=\jazzside, xshift=\jazzboxhshift, yshift=\jazzboxvshift, inner sep=4pt]
        (cautionbox\thecautioncount)
        at ([yshift=3pt]current page text area.\jazzotherside|-\thecautioncount)
        {\parbox{\marginparwidth-8pt}{\vskip4pt\footnotesize#3\vskip2pt}};
      \node[fill=white, font=\sffamily, anchor=west, inner sep=2pt, xshift=7pt, yshift=0pt]
        at (cautionbox\thecautioncount.north west)
        {\footnotesize\enspace\textcolor{black}{\textsc{#4}}\enspace};
      \fill[#2]
        ([yshift=\jazzuppertrianglecorner]\jazzpointeranchor) --
        ([yshift=\jazzuppertrianglecorner-3pt,xshift=\jazztrianglexshift]\jazzpointeranchor) --
        ([yshift=\jazzuppertrianglecorner-6pt]\jazzpointeranchor) -- cycle;
    \end{tikzpicture}%
  }%
}

\NewDocumentCommand{\cautionleft}{ O{c} D<>{firstcolor} m G{\defaultcautionboxname} }{%
  \setlength\jazztrianglexshift{3pt}%
  \setlength\jazzboxhshift{-\marginparsep}%
  \renewcommand{\jazzside}{east}%
  \renewcommand{\jazzotherside}{west}%
  \settoheight{\jazznoteheight}{\parbox{\marginparwidth-8pt}{\footnotesize#3}}%
  \stepcounter{cautioncount}%
  \jazztikzmark{\thecautioncount}%
  \if#1b\relax
    \renewcommand\jazzpointeranchor{cautionbox\thecautioncount.south \jazzside}%
    \renewcommand\jazzboxanchor{south \jazzside}%
    \setlength\jazzboxvshift{\jazznoteheight}%
    \addtolength\jazzboxvshift{-.6\baselineskip}% Adjust the vertical shift with the text line
    \setlength\jazzuppertrianglecorner{13pt}%
  \else
    \if#1t\relax
      \renewcommand\jazzpointeranchor{cautionbox\thecautioncount.north \jazzside}%
      \renewcommand\jazzboxanchor{north \jazzside}%
      \setlength\jazzboxvshift{-\jazznoteheight}%
      \addtolength\jazzboxvshift{.6\baselineskip}% Adjust the vertical shift with the text line
      \setlength\jazzuppertrianglecorner{-7pt}%
    \else
      \if#1c\relax
        \renewcommand\jazzpointeranchor{cautionbox\thecautioncount.\jazzside}%
        \renewcommand\jazzboxanchor{\jazzside}%
        %\setlength\jazzboxvshift{\baselineskip}% No vertical shift, just centered with the text line
        \setlength\jazzuppertrianglecorner{3pt}%
      \fi%
    \fi%
  \fi%
  \marginnote{%
    \begin{tikzpicture}[remember picture, overlay]
      \node[draw=#2, thick, anchor=\jazzside, xshift=\jazzboxhshift, yshift=\jazzboxvshift, inner sep=4pt]
        (cautionbox\thecautioncount)
        at ([yshift=3pt]current page text area.\jazzotherside|-\thecautioncount)
        {\parbox{\marginparwidth-8pt}{\vskip4pt\footnotesize#3\vskip2pt}};
      \node[fill=white, font=\sffamily, anchor=west, inner sep=2pt, xshift=7pt, yshift=0pt]
        at (cautionbox\thecautioncount.north west)
        {\footnotesize\enspace\textcolor{black}{\textsc{#4}}\enspace};
      \fill[#2]
        ([yshift=\jazzuppertrianglecorner]\jazzpointeranchor) --
        ([yshift=\jazzuppertrianglecorner-3pt,xshift=\jazztrianglexshift]\jazzpointeranchor) --
        ([yshift=\jazzuppertrianglecorner-6pt]\jazzpointeranchor) -- cycle;
    \end{tikzpicture}%
  }%
}

%- Full text width note (stolen to Paul Gaborit, `ocgx' package)
\newcounter{linewidthnote}
\newenvironment{linewidthnote}{% A priori non breakable, take care!
  \vspace{6pt}
  \noindent
  \tikzpicture
  \node[%draw=black,line width=.1pt,
    rounded corners=0.5em,%1em,
    inner xsep=1.3em, inner ysep=.8em,
    text width=\linewidth-2.6em-\pgflinewidth,
    align=justify,
    %draw=cyan!50!black,
    draw=firstcolor,
    fill=black!3,%white,
    %fill=yellow!20,
    line width=1pt,
    %drop shadow={fill=cyan!50!black},
    drop shadow={fill=firstcolor},
  ] (linewidthnote) \bgroup%
}{%
  \egroup;
  \node[circle, overlay,
    %fill=white,draw=cyan!50!black,
    draw=white,
    %fill=cyan!50!black,
    fill=firstcolor,
    text=white,
    line width=2pt,
    %drop shadow={fill=cyan!50!black},
    drop shadow={fill=firstcolor},
    font=\small\bfseries,inner sep=4pt]
    at ([yshift=-2pt]linewidthnote.north west){\stepcounter{linewidthnote}\arabic{linewidthnote}};
  \endtikzpicture\par\vspace{.1em}%
}

\NewTColorBox{gofurther}{o g}{% #1 = more options; #2 = another title
%\newtcolorbox{gofurther}[1][]{% optional arg = more options list
  breakable,
  enhanced jigsaw,
  check odd page,
  width=\linewidth,
  %parbox=false,
  %colframe=secondcolor,
  colbacktitle=secondcolor,
  colback=gray!20,
  arc = 0pt, outer arc = 0pt,
  boxrule = 0pt,
  %leftrule = 2pt, rightrule = 2pt,
  %toprule=0pt, bottomrule = 0pt,
  boxsep = 0pt,% default=1mm
  toptitle=5pt, bottomtitle=3pt,% additional to boxsep, default=0mm
  lefttitle = 6pt, righttitle = 6pt,% additional to boxsep, default=4mm
  IfValueTF={#2}{%
    title=\strut\textsc{\boxtitlefont #2~\hrulefill}%  
  }{title=\ifbool{highlight@usefrenchlanguage}%
      {\strut\textsc{\boxtitlefont Pour aller plus loin...~\hrulefill}}%
      {\strut\textsc{\boxtitlefont To go further...~\hrulefill}}
  },
  top = 6pt, bottom = 4pt,% additional to boxsep, default=2mm
  left = 6pt, right = 6pt,% additional to boxsep, default=4mm
  before skip=10pt,
  after skip=2pt,
  IfValueTF={#1}{#1}{},
}

\NewTColorBox{jazzbox}{o g}{% #1 = more options; #2 = another title
%\newtcolorbox{gofurther}[1][]{% optional arg = more options list
  breakable,
  enhanced jigsaw,
  check odd page,
  width=\linewidth,
  %parbox=false,
  %colframe=secondcolor,
  colbacktitle=firstcolor,
  colback=gray!20,
  arc = 0pt, outer arc = 0pt,
  boxrule = 0pt,
  %leftrule = 2pt, rightrule = 2pt,
  %toprule=0pt, bottomrule = 0pt,
  boxsep = 0pt,% default=1mm
  toptitle=5pt, bottomtitle=3pt,% additional to boxsep, default=0mm
  lefttitle = 6pt, righttitle = 6pt,% additional to boxsep, default=4mm
  IfValueTF={#2}{%
    title=\strut\textsc{\boxtitlefont #2~\hrulefill}%  
  }{title=\ifbool{highlight@usefrenchlanguage}%
      {\strut\textsc{\boxtitlefont Remarque circonstanciée~\hrulefill}}%
      {\strut\textsc{\boxtitlefont Detailed remark...~\hrulefill}}
  },
  top = 6pt, bottom = 4pt,% additional to boxsep, default=2mm
  left = 6pt, right = 6pt,% additional to boxsep, default=4mm
  before skip=10pt,
  after skip=2pt,
  IfValueTF={#1}{#1}{},
}

% DEPRECATED: USE jazzbox ENVIRONMENT
\NewTColorBox{tcbcontents}{o g}{% #1 = more options; #2 = another title
%\newtcolorbox{gofurther}[1][]{% optional arg = more options list
  breakable,
  enhanced jigsaw,
  check odd page,
  width=\linewidth,
  %parbox=false,
  %colframe=secondcolor,
  colbacktitle=firstcolor,
  colback=gray!20,
  arc = 0pt, outer arc = 0pt,
  boxrule = 0pt,
  %leftrule = 2pt, rightrule = 2pt,
  %toprule=0pt, bottomrule = 0pt,
  boxsep = 0pt,% default=1mm
  toptitle=5pt, bottomtitle=3pt,% additional to boxsep, default=0mm
  lefttitle = 6pt, righttitle = 6pt,% additional to boxsep, default=4mm
  IfValueTF={#2}{%
    title=\strut\textsc{\boxtitlefont #2~\hrulefill}%  
  }{title=\ifbool{highlight@usefrenchlanguage}%
      {\strut\textsc{\boxtitlefont Remarque circonstanciée~\hrulefill}}%
      {\strut\textsc{\boxtitlefont Detailed remark...~\hrulefill}}
  },
  top = 6pt, bottom = 4pt,% additional to boxsep, default=2mm
  left = 6pt, right = 6pt,% additional to boxsep, default=4mm
  before skip=10pt,
  after skip=2pt,
  IfValueTF={#1}{#1}{},
}

\ifbool{@twoside}{%
  \NewTColorBox{gofurther*}{o g}{% #1 = more options; #2 = another title
    breakable,
    enhanced jigsaw,
    check odd page,
    toggle left and right,
    grow to right by=\marginparwidth+\marginparsep,
    toggle enlargement=evenpage, 
    notitle after break,
    colbacktitle=secondcolor,
    colback=gray!20,
    arc = 0pt, outer arc = 0pt,
    boxrule = 0pt,
    boxsep = 0pt,% default=1mm
    toptitle=5pt, bottomtitle=3pt,% additional to boxsep, default=0mm
    lefttitle = 6pt, righttitle = 6pt,% additional to boxsep, default=4mm
    IfValueTF={#2}{%
      title=\strut\textsc{\boxtitlefont #2~\hrulefill}%  
    }{title=\ifbool{highlight@usefrenchlanguage}%
        {\strut\textsc{\boxtitlefont Pour aller plus loin...~\hrulefill}}%
        {\strut\textsc{\boxtitlefont To go further...~\hrulefill}}
    },
    top = 6pt, bottom = 4pt,% additional to boxsep, default=2mm
    left = 6pt, right = 6pt,% additional to boxsep, default=4mm
    before skip=10pt,
    after skip=2pt,
    IfValueTF={#1}{#1}{},
  }
  \DeclareDocumentCommand{\sidequote}{o m O{-18mm}}{%
    \marginpar{%
      \strictpagechecktrue%
      \checkoddpage%
      \ifoddpage%
        \RaggedLeft%
      \else%
        \RaggedLeft%
      \fi
      \llap{\raisebox{-1.8cm}[0mm][0mm]{\quotestart\IfValueT{#3}{\hspace{#3}}}}%
      {\small\itshape#2}%
      \IfValueT{#1}{%
        \setlength{\parskip}{\baselineskip/2}%
        \begingroup\setlength\topsep{0pt}%
        \begin{flushright}%
          \small --- #1%
        \end{flushright}%
        \endgroup%
      }%
    }\unskip%
  }
}{%- Cf. https://tex.stackexchange.com/questions/396660/ and doc. v.4.30 p.46
  \ifbool{@reversemargin}{%
    \NewTColorBox{gofurther*}{o g}{% #1 = more options; #2 = another title
      breakable,
      enhanced jigsaw,
      check odd page,
      toggle left and right,
      grow to left by=\marginparwidth+\marginparsep,
      toggle enlargement=evenpage, 
      colbacktitle=secondcolor,
      colback=gray!20,
      arc = 0pt, outer arc = 0pt,
      boxrule = 0pt,
      %leftrule = 2pt, rightrule = 2pt,
      %toprule=0pt, bottomrule = 0pt,
      boxsep = 0pt,% default=1mm
      toptitle=5pt, bottomtitle=3pt,% additional to boxsep, default=0mm
      lefttitle = 6pt, righttitle = 6pt,% additional to boxsep, default=4mm
      IfValueTF={#2}{%
        title=\strut\textsc{\boxtitlefont #2~\hrulefill}%  
      }{%
        \ifbool{highlight@usefrenchlanguage}%
          {title=\strut\textsc{\boxtitlefont Pour aller plus loin...~\hrulefill}}%
          {title=\strut\textsc{\boxtitlefont To go further...~\hrulefill}}
      },
      top = 6pt, bottom = 4pt,% additional to boxsep, default=2mm
      left = 6pt, right = 6pt,% additional to boxsep, default=4mm
      before skip=10pt,
      after skip=2pt,
      IfValueTF={#1}{#1}{},
    }
    \DeclareDocumentCommand{\sidequote}{o m O{0mm}}{%
      \marginpar{%
        \strictpagechecktrue%
        \checkoddpage%
        \ifoddpage%
          \RaggedLeft%
        \else%
          \RaggedRight%
        \fi
        \llap{\raisebox{-1.8cm}[0mm][0mm]{\quotestart\IfValueT{#3}{\hspace{#3}}}}%
        {\small\itshape#2}%
        \IfValueT{#1}{%
          \setlength{\parskip}{\baselineskip/2}%
          \begingroup\setlength\topsep{0pt}%
          \begin{flushright}%
            \small --- #1%
          \end{flushright}%
          \endgroup%
        }%
      }\unskip%
    }
  }{\NewTColorBox{gofurther*}{o g}{% #1 = more options; #2 = another title
      breakable,
      enhanced jigsaw,
      check odd page,
      toggle left and right,
      grow to right by=\marginparwidth+\marginparsep,
      toggle enlargement=evenpage, 
      colbacktitle=secondcolor,
      colback=gray!20,
      arc = 0pt, outer arc = 0pt,
      boxrule = 0pt,
      boxsep = 0pt,% default=1mm
      toptitle=5pt, bottomtitle=3pt,% additional to boxsep, default=0mm
      lefttitle = 6pt, righttitle = 6pt,% additional to boxsep, default=4mm
      IfValueTF={#2}{%
        title=\strut\textsc{\boxtitlefont #2~\hrulefill}%  
      }{%
        title=\ifbool{highlight@usefrenchlanguage}%
        {\strut\textsc{\boxtitlefont Pour aller plus loin...~\hrulefill}}%
        {\strut\textsc{\boxtitlefont To go further...~\hrulefill}}
      },
      top = 6pt, bottom = 4pt,% additional to boxsep, default=2mm
      left = 6pt, right = 6pt,% additional to boxsep, default=4mm
      before skip=10pt,
      after skip=2pt,
      IfValueTF={#1}{#1}{},
    }
    \DeclareDocumentCommand{\sidequote}{o m O{-18mm}}{%
      \marginpar{%
        \strictpagechecktrue%
        \checkoddpage%
        \ifoddpage%
          \RaggedLeft%
        \else%
          \RaggedRight%
        \fi
        \llap{\raisebox{-1.8cm}[0mm][0mm]{\quotestart\IfValueT{#3}{\hspace{#3}}}}%
        {\small\itshape#2}%
        \IfValueT{#1}{%
          \setlength{\parskip}{\baselineskip/2}%
          \begingroup\setlength\topsep{0pt}%
          \begin{flushright}%
            \small --- #1%
          \end{flushright}%
          \endgroup%
        }%
      }\unskip%
    }
  }
}

%-- Quotation
%------------

\newcommand{\quotestart}{
  \fontsize{3cm}{0mm}\selectfont%
  \color{middlegrey}%
  {\fontspec{Lora Bold Italic}“}
}

\NewDocumentCommand{\blockquotation}{o m O{-16mm}}{% \blockquote already defined! Where?
  \vskip \baselineskip
  \hfill\begin{minipage}{.92\linewidth}
    \mbox{}%
    \setlength{\parindent}{0pt}%
    \setlength{\parskip}{\baselineskip}%
    \llap{\raisebox{-1.5cm}[0mm][0mm]{\quotestart\IfValueT{#3}{\hspace{#3}}}}
    {\itshape#2}
    \IfValueT{#1}{
      \setlength{\parskip}{\baselineskip/2}%
      \begingroup\setlength\topsep{0pt}
      \begin{flushright}
        --- #1
      \end{flushright}
      \endgroup
    }
  \end{minipage}
  \vskip \baselineskip
}

%-- With package `quoting' (egreg)
%- http://tex.stackexchange.com/questions/162782/[...]
%-    [...]how-to-configure-redefine-the-quotation-environment-to-cite
\RequirePackage{quoting}

\NewDocumentEnvironment{citequote}{ o g }
  % Syntax − #1 = optional author, #2 = optional bibliographic reference
 {%
  \begin{quoting}[indentfirst=false,font=itshape]
  \bigquotes{r}{\textcolor{black!45}{``}}\ignorespaces
 }
 {%
  \unskip\bigquotes{l}{\textcolor{black!45}{''}}%
  \IfValueTF{#2}
    {\item\relax\hspace*{\fill}\citeauthor{#2}\ \textup{\cite{#2}}}
    {\IfValueTF{#1}
      {\item\relax\hspace*{\fill}\textup{#1}}
      {\item\relax}
    }%
  \end{quoting}
 }
\newcommand{\bigquotes}[2]{%
  \makebox[0pt][#1]{%
    \raisebox{\dimexpr\fontcharht\font`A-\height}{\Large\bfseries#2}%
  }%
}

%-- Marker/note box: stolen to Thomas F. Sturm (tcolorbox documentation)
%-- See: https://tex.stackexchange.com/questions/251802/simulating-the-look-of-curled-paper

\NewTColorBox{marker}{ O{} D<>{\linewidth} G{} }{% ref.: tcolorbox.doc.s_main.sty
  enhanced,
  before skip=4pt, after skip=4pt,
  boxrule=0.4pt, 
  left=4pt, right=4pt, 
  top=2pt, bottom=4pt,
  colbacktitle=firstcolor,
  fonttitle=\strut\scshape\boxtitlefont,
  coltitle=white,
  %colback=yellow!50,
  colback=black!3,
  colframe=firstcolor!20!black,
  sharp corners, 
  rounded corners=southeast, 
  arc is angular, 
  arc=3mm,
  drop fuzzy shadow,
  underlay={%
    \path[fill=firstcolor!80!black]
      ([yshift=3mm]interior.south east) -- ++(-0.4,-0.1) -- ++(0.1,-0.2);
    \path[draw=tcbcolframe,shorten <=-0.05mm,shorten >=-0.05mm]
      ([yshift=3mm]interior.south east) -- ++(-0.4,-0.1) -- ++(0.1,-0.2);
  },
  %underlay={%
    %\path[fill=tcbcolback!80!black, draw=tcbcolframe, shorten <=-0.05mm, shorten >=-0.05mm] 
    %  ([yshift=9mm]interior.south east) .. controls +(-.25,-.25) and +(.5,-.35) ..  
    %  ++(-1.2,-.2) .. controls +(.5,-.4) and +(.1,.15) .. ([xshift=-9mm]interior.south east);
  %},
  title={#3},
  width=#2,
  IfValueTF={#1}{#1}{},
}







































