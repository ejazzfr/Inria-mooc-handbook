%%
%% texjazz-margin.ltx
%%
%% A LaTeX file to deal with margin contents.
%%
%% Copyright (c) 2020-2021 ejazz.
%%
%---------------------------------------------------------------------------------------------------
% This work is part of the TeXjazz bundle. It may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% The Current Maintainer of this work is ejazz <ejazz.fr@gmail.com>.
%
% This work consists of the files:
%     `texjazz-margin.ltx' and `texjazz-margin[-fr].tex' (not yet fully available).
% --------------------------------------------------------------------------------------------------

%-- File identification
%----------------------

\ProvidesFile{texjazz-margin.ltx}[2021/02/08 v0.1a − Management of margin contents]

%\RequirePackage{etoolbox,pgfopts,marginnote}
%\@ifpackageloaded{zref-abspage}% Deleting the perpage notes option
%  {\RequirePackage{perpage}}
%  {\AtEndPreamble{\RequirePackage{perpage}}}

%-- Programming utilities
%------------------------

%- French language
\newbool{jazz@margin@usefrenchlanguage}% To be extended for compliance with language packages
\booltrue{jazz@margin@usefrenchlanguage}

%- Side notes definition: `sidenodes' or `snotez` package language
\newbool{jazz@margin@sidenotes}% To be extended for compliance with language packages
\booltrue{jazz@margin@sidenotes}

\PassOptionsToPackage{noparboxrestore}{marginnote}
\RequirePackage{marginnote}% Managing non floating margin elements

%- Provides commands/environment according to the page `side' (odd/even)
%\RequirePackage[strict]{changepage}% Already loaded by texjazz-common.ltx

%- Adds commands to put contents according to the current page `side'
%\RequirePackage{ifoddpage}% Must be loaded *after* the `changepage' package because redefines macros

%- Arranges marginpars "intelligently" / Automatically adjust the side material nicely
\RequirePackage{marginfix}

%- Alignement du texte avec césures correctes
%\RequirePackage{ragged2e}% Already loaded by texjazz-common.ltx

%- Lengths and dimension layout
\setlength{\marginparpush}{\baselineskip}% vertical space of consecutive sidenotes
\setlength{\columnsep}{\marginparsep}

%-- Basic margin elements
%------------------------

\NewDocumentCommand{\marginelement}{ O{\footnotesize} m}{%
  \marginpar{%
    \strictpagechecktrue%
    \checkoddpage%
    \ifoddpageoroneside
      \ifbool{@reversemargin}{#1}{#1}%
    \else%
      #1%
    \fi%
    #2%
  }\unskip%
}%

\NewDocumentCommand{\margincontents}{ O{\footnotesize} m}{%
  \marginpar{%
    \strictpagechecktrue%
    \checkoddpage%
    \ifoddpageoroneside
      \ifbool{@reversemargin}%
        {\RaggedLeft #1}
        {\RaggedRight #1}%
    \else%
      \RaggedLeft #1%
    \fi%
    #2%
  }\unskip%
}%

\NewDocumentCommand{\sidemark}{O{secondcolor} m}{{\color{#1}\normalfont#2.{\:}}}

%- Side note with forced position
\NewDocumentCommand{\forcedsidenote}{O{secondcolor} m}{%
  {%
    \hypersetup{linkcolor=maincolor}%
    \normalfont%
    \footnotemark%
  }%
  \ignorespaces%
  \marginnote{
    \strictpagechecktrue
    \checkoddpage
    \ifoddpage%
      \RaggedRight\footnotesize%
    \else%
      \RaggedLeft\footnotesize%
    \fi%
    \sidemark[#1]{\thefootnote}%
    \ignorespaces%
    #2%
  }%
}

%-- Sidenote from the sidenotes package
%--------------------------------------

%- LaTex3 implementation of sidenotes, for compatibility (clashes because we use same names commands)

%- Detects empty arguments "LaTeX3 way"
%- https://tex.stackexchange.com/questions/63223/xparse-empty-arguments

%\RequirePackage{sidenotes}

%--- Sidenotes macros (TODO: implement some ideas)
%- Based on `sidenotes' macros, switching between marginpar and marginote without overlap
%\RequirePackage{sidenotes}% use marginnote (fixed) or marginpar (float)
%---

%-- Sidenote command definition (\sidenote) stolen to the `sidenotes` package
%----------------------------------------------------------------------------

%- TODO: really understand ALL the code! Not fully done for the moment being... But it works!

%- All the `sidenotes' package code is copied below, and commented
%- to avoid conflict with our previous attempts for the same goal

%\RequirePackage{l3keys2e}% May be put at the beginning of the class (not needed: for options)
%\RequirePackage{expl3}% Already loaded at the beginning of the class (see above)
%\ProvidesExplPackage{sidenotes}{2016/04/21}{1.00}{rich text in the margin for LaTeX}% (not needed)
%\RequirePackage{marginnote}% provides an offset option for the marginals instead of a float
%\RequirePackage{caption}% handles the captions (in the margin)
%\RequirePackage{xparse}% new LaTeX3 syntax to define macros and environments
%\RequirePackage[strict]{changepage} % Changepage package for symmetric twoside handling
\ExplSyntaxOn
%\keys_define:nn { sidenotes }
%  {
%    oneside .bool_set:N = \sidenotes_oneside
%  }
%\ProcessKeysOptions { sidenotes }
\newcounter{sidenote} % make a counter
%\setcounter{sidenote}{1} % init the counter − Original
%\setcounter{sidenote}{0} % init the counter: not needed with our modifications
\DeclareExpandableDocumentCommand{\IfNoValueOrEmptyTF}{ m m m }% Already defined (egreg L3 command)
{
 \IfNoValueTF{#1}
  {#2}
  {\tl_if_empty:nTF {#1} {#2} {#3}}
}
\NewDocumentCommand{\@sidenotes@thesidenotemark}{ m }{% See latex.ltx \@footnotemark definition
	\leavevmode
	\ifhmode\edef\@x@sf{\the\spacefactor}\nobreak\fi
	%\hbox {\@textsuperscript {\normalfont #1 }}% Original
	\hbox{\@textsuperscript{\color{secondcolor}\normalfont#1}}% See latex.ltx \@makefnmark definition
	\ifhmode\spacefactor\@x@sf\fi
	\relax
}
\NewDocumentCommand{\@sidenotes@multisign}{ }{3sp}
\NewDocumentCommand{\@sidenotes@multimarker}{ }{%
	\kern-\@sidenotes@multisign
	\kern\@sidenotes@multisign\relax
}
\NewDocumentCommand{\@sidenotes@multichecker}{ }{%
	\dim_compare:nNnTF \lastkern = \@sidenotes@multisign
	{\@sidenotes@thesidenotemark{,}}
	%{}% Original: no extra space between text and note numbering
	{\hspace*{0.5pt}}% Adding a small space between text and note numbering
}
\NewDocumentCommand{\@sidenotes@placemarginal}{ m m }{%
	\IfNoValueOrEmptyTF{#1}
		{\marginpar{#2}}
		{\marginnote{#2}[#1]}
}
\NewDocumentCommand{\sidenote}{ o o +m }{%
  \sidenotemark[#1]
  \sidenotetext[#1][#2]{#3}
  \@sidenotes@multimarker
}
\NewDocumentCommand{\sidenotemark}{ o }{%
  \@sidenotes@multichecker
  \IfNoValueOrEmptyTF{#1}
    {\@sidenotes@thesidenotemark{\thesidenote}}
    {\@sidenotes@thesidenotemark{#1}}
  \@sidenotes@multimarker
}
\NewDocumentCommand{\sidenotetext}{ o o +m }{%
	\IfNoValueOrEmptyTF{#1}{%
		%\@sidenotes@placemarginal{#2}{\textsuperscript{\thesidenote}{}~\footnotesize#3}% Original
		\@sidenotes@placemarginal{#2}{% French layout
			%\footnotesize\textcolor{secondcolor}{\thesidenote.\:}#3%
			\footnotesize\textcolor{secondcolor}{\thesidenote.~}#3%
		}%
		\refstepcounter{sidenote}
	}{%
		\@sidenotes@placemarginal{#2}{\textsuperscript{#1}~\footnotesize#3}% To be modified
	}
}
%- Following the idea from: https://tex.stackexchange.com/questions/434023/reference-to-sidenote
%- some adjustments have to be done to \sidenotetext and \sidenote
\RenewDocumentCommand{\sidenote}{ o o +m }{%
	\@sidenotes@multichecker
  \sidenotetext[#1][#2]{#3}
  \sidenotemark[#1]
  \@sidenotes@multimarker
}
\RenewDocumentCommand{\sidenotetext}{ o o +m }{%
	\IfNoValueOrEmptyTF{#1}{%
		\refstepcounter{sidenote}
		%\@sidenotes@placemarginal{#2}{\textsuperscript{\thesidenote}{}~\footnotesize#3}% Original
		\@sidenotes@placemarginal{#2}{% French layout
			%\footnotesize\textcolor{secondcolor}{\thesidenote.\:}#3%
			\footnotesize\textcolor{secondcolor}{\thesidenote.~}#3%
		}%
	}{%
		\@sidenotes@placemarginal{#2}{\textsuperscript{#1}~\footnotesize#3}% To be modified
	}
}
%\DeclareCaptionStyle{sidecaption}{font=footnotesize}
%\NewDocumentCommand \sidecaption {s o o m}
%{
%  \captionsetup{style=sidecaption}
%  \IfBooleanTF{#1}
%  { % starred
%    \IfNoValueOrEmptyTF{#2}
%    {\marginnote{\caption*{#4}}}
%    {\marginnote{\caption*{#4}}[#2]}
%  }
%  { % unstarred
%  \IfNoValueOrEmptyTF{#2}
%    {\def\@sidenotes@sidecaption@tof{#4}}
%    {\def\@sidenotes@sidecaption@tof{#2}}
%  \IfNoValueOrEmptyTF{#3}
%    {\marginnote{\caption[\@sidenotes@sidecaption@tof]{#4}}}
%    {\marginnote{\caption[\@sidenotes@sidecaption@tof]{#4}}[#3]}
%  }
%}
%\newsavebox{\@sidenotes@marginfigurebox}
%\DeclareCaptionStyle{marginfigure}{font=footnotesize}
%\NewDocumentEnvironment{marginfigure} { o }
%{
%  \begin{lrbox}{\@sidenotes@marginfigurebox}
%    \begin{minipage}{\marginparwidth}
%      \captionsetup{type=figure,style=marginfigure}
%}
%{
%    \end{minipage}%
%  \end{lrbox}%
%  \@sidenotes@placemarginal{#1}{\usebox{\@sidenotes@marginfigurebox}}
%}
%\newsavebox{\@sidenotes@margintablebox}
%\DeclareCaptionStyle{margintable}{font=footnotesize}
%\NewDocumentEnvironment{margintable} { o }
%{
%  \begin{lrbox}{\@sidenotes@margintablebox}
%    \begin{minipage}{\marginparwidth}
%      \captionsetup{type=table,style=margintable}
%}
%{
%    \end{minipage}
%  \end{lrbox}
%  \@sidenotes@placemarginal{#1}{\usebox{\@sidenotes@margintablebox}}
%}
%\AtBeginDocument{%
%\newlength{\@sidenotes@extrawidth}
%\setlength{\@sidenotes@extrawidth}{\marginparwidth}
%\addtolength{\@sidenotes@extrawidth}{\marginparsep}}
%\NewDocumentEnvironment{autoadjustwidth}{ m m }%
%{
%    \bool_if:NTF \sidenotes_oneside
%    {
%        \begin{adjustwidth}{#1}{#2}
%    }
%    {
%        \begin{adjustwidth*}{#1}{#2}
%    }
%}
%{
%    \bool_if:NTF \sidenotes_oneside
%    {
%        \end{adjustwidth}
%    }
%    {
%        \end{adjustwidth*}
%    }
%}
%\DeclareCaptionStyle{widefigure}{font=footnotesize}
%\RenewDocumentEnvironment{figure*}{ O{htbp} }
%{
%    \begin{figure}[#1]
%        \begin{autoadjustwidth}{}{-\@sidenotes@extrawidth}
%        \captionsetup{style=widefigure}
%}
%{
%        \end{autoadjustwidth}
%    \end{figure}
%}
%\DeclareCaptionStyle{widetable}{font=footnotesize}
%\RenewDocumentEnvironment{table*}{ O{htbp} }
%{
%    \begin{table}[#1]
%        \begin{autoadjustwidth}{}{-\@sidenotes@extrawidth}
%        \captionsetup{style=widetable}
%}
%{
%        \end{autoadjustwidth}
%    \end{table}
%}
\ExplSyntaxOff

%-- Side "fake float" as environments: borrowed to the Tüfte class
%-----------------------------------------------------------------

\newsavebox{\@jazz@margin@floatbox}% Based on an idea in tufte-latex (see also snotez.sty)
\newenvironment{jazz@margin@float}[2][0pt]{%[-1.2ex]{%
  \FloatBarrier% process all floats before this point so the figure/table numbers stay in order.
  \begin{lrbox}{\@jazz@margin@floatbox}%
    \begin{minipage}{\marginparwidth}%
      \captionsetup*{type=#2, font=footnotesize,
        format=plain, indention={1mm+.5em}, list=true}% Fake a figure environment
      \hbox{}\vspace*{#1}%
      \centering%
      \@afterindentfalse\@afterheading%
}{\end{minipage}%
  \end{lrbox}%
  \marginpar{\usebox{\@jazz@margin@floatbox}}%
}

%- First approach with bug (?) in the LoF
\NewDocumentEnvironment{marginfigure}{ o G{0pt} }%
  % Syntax − optional #1 = caption, optional #2 = vertical shift
  {\begin{jazz@margin@float}[#2]{figure}}%
  {\IfValueT{#1}{\caption{#1}}\end{jazz@margin@float}}

%- Margin table environment
\NewDocumentEnvironment{margintable}{ o G{0pt} }%
  % Syntax − optional #1 = caption, optional #2 = vertical shift
  {\begin{jazz@margin@float}[#2]{table}}%
  {\IfValueT{#1}{\caption{#1}}\end{jazz@margin@float}}

\NewDocumentEnvironment{margingraphic}{ o G{0pt} }{%
  % Syntax − optional #1 = caption, optional #2 = vertical shift
  \begin{jazz@margin@float}[#2]{graphic}%
%}{\IfValueT{#1}{\captionof{figure}{#1}}% Because in minipage the hypcap anchor setting is correct
}{\IfValueT{#1}{\caption{#1}}\end{jazz@margin@float}%
  %\IfValueT{#1}{\sidecaptionlist{figure}{#1}}%
}

%- Margin video environment
\newsavebox{\@jazz@margin@video}
\newenvironment{jazz@margin@video}[2][0pt]{%[-1.2ex]{%
  \FloatBarrier% process all floats before this point so the figure/table numbers stay in order. Not always WHY?
  \begin{lrbox}{\@jazz@margin@video}%
    \begin{minipage}{\marginparwidth}%
      \captionsetup*{type=#2, font=footnotesize,
        format=plain, indention={1mm+.5em}, list=false}% Fake a figure environment
      \hbox{}\vspace*{#1}%
      \centering%
      \@afterindentfalse\@afterheading%
}{\end{minipage}%
  \end{lrbox}%
  \marginpar{\usebox{\@jazz@margin@video}}%
}
\NewDocumentEnvironment{marginvideo}{ o G{0pt} D<>{\faVideoCamera} }{% optional arg#1 = caption
  \begin{jazz@margin@video}[#2]{video}%
}{\IfValueT{#1}{\captionof{video}{#1}}% Because in minipage the hypcap anchor setting is correct
  \end{jazz@margin@video}%
  %\IfValueT{#1}{\sidecaptionlist{video}{%
  %  #1\enspace\textcolor{secondcolor}{\normalfont\small\faVideoCamera}}}%
  \IfValueT{#1}{% Adding an entry in LoV
    \IfNoValueTF{#3}%
      {\sidecaptionlist{video}{#1}}%
      {\sidecaptionlist{video}{#1\textcolor{secondcolor}{%
        \normalfont\footnotesize\ifblank{#3}{}{\enspace}#3}}}%
  }
}
\NewDocumentEnvironment{marginvideo*}{ o O{0pt} }{% optional arg#1 = caption but not in LoV
  \begin{jazz@margin@video}[#2]{video}%
}{\IfValueT{#1}{\captionof{video}{#1}}% Because in minipage the hypcap anchor setting is correct
  \end{jazz@margin@video}%
}

%-- Margin stuff
%---------------

% https://tex.stackexchange.com/questions/3657/get-the-size-that-a-figure-is-being-rendered

%- Applying the same method for \caution command to here put the graphic copyright
\newcommand{\graphictikzmark}[1]{%
  \tikz[remember picture,overlay]\node[inner xsep=0pt,outer sep=0pt] (#1) {};}

\newcounter{graphiccount}
\newlength{\graphicboxhshift}
\newlength{\graphicboxvshift}
\newlength{\graphiccreditshift}
\newcommand{\graphicside}{}
\newcommand{\graphicotherside}{}
\newcommand{\graphicrotateangle}{}

%\newlength{\graphicvoffset}
%\setlength{\graphicvoffset}{\dimexpr2mm+3pt+2pt\relax}
%\setlength{\graphicvoffset}{0.3\baselineskip}% Assuming ht=0.7\baselineskip and dp=0.3\baselineskip
%\setlength{\graphicvoffset}{4pt}% Arbitrary value. TODO: calculate it precisely

\newtcolorbox{measuregraphicbox}[2][]{% From http://tex.stackexchange.com/questions/203194/
  blank, parbox=false,%show bounding box,
  overlay={\xdef#2{\tcb@height}},
  #1
}

%- Side graphic: environment for unmumbered figure or illustration (with or without a caption)
\NewDocumentCommand{\sidegraphic}{s o m g}{% Built upon marginpar
  % Syntax − #1 = no star = copyright symbol, star = no copyright symbol
  %          #2 = caption text
  %          #3 = margin contents: an image file (or more) included with \includegraphics
  %          #4 = optional copyright/source of the graphic (graphics are different from figures)
  %\hspace{0pt}%
  \leavevmode% https://tex.stackexchange.com/questions/395826 (That's the solution! Marvellous!)
  \marginpar{% more flexible, but... Lost floats?
  %\marginnote{% Seems to solve the "lost floats" issue. Yes, but... to clarify and be understood
    %\vspace*{2pt}% compensate an unknown gap TODO: find the issue!
    %\vspace*{\baselineskip}% compensate an unknown gap TODO: find the issue!
    \IfValueTF{#4}{%
      \stepcounter{graphiccount}%
      \graphictikzmark{\thegraphiccount}%
      %- Box height measurement is done with the twin command used for margin ToC
      \begin{measuregraphicbox}[nobeforeafter]{\graphicboxheight}%, show bounding box
        \centering%
        \@afterindentfalse\@afterheading%
        #3%
      \end{measuregraphicbox}%
      \strictpagechecktrue%
      \checkoddpage%
      \ifoddpageoroneside%
        \setlength{\graphicboxhshift}{\marginparsep}%
        \setlength{\graphicboxvshift}{5pt}%
        \renewcommand{\graphicside}{west}%
        \renewcommand{\graphicotherside}{east}%
        \renewcommand{\graphicrotateangle}{90}%
      \else%
        \settowidth{\graphiccreditshift}{%
          \IfBooleanTF{#1}%
            {\scriptsize\space#4}%
            %{\scriptsize\faCopyright\space#4}%
            {\scriptsize Crédit :\space#4}%
        }%
        %\setlength{\graphicboxhshift}{%
        %  -\marginparwidth-.5\marginparsep-.5\graphiccreditshift-0.4pt}%-0.8pt}%-1.6pt}% thick=0.8pt
        \setlength{\graphicboxhshift}{%
          -\marginparwidth-\marginparsep-\graphicboxheight+\graphiccreditshift}%
        \setlength{\graphicboxvshift}{\marginparwidth+5pt}%
        \renewcommand{\graphicside}{east}%
        \renewcommand{\graphicotherside}{west}%
        \renewcommand{\graphicrotateangle}{-90}%
      \fi%
      \begin{tikzpicture}[remember picture,overlay]
        \node[%draw=red, thick,
              anchor=\graphicside,
              %rotate=0,%\graphicrotateangle,
              rotate around={\graphicrotateangle:(\thegraphiccount)},
              xshift=\graphicboxhshift, yshift=\graphicboxvshift,
              inner sep=0pt]
          (graphicbox\thegraphiccount)
          at ([yshift=0pt]current page text area.\graphicotherside|-\thegraphiccount)
          %{\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize\faCopyright\space#4}};%
          {\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize Crédit :\space#4}};%
          %{\scriptsize\faCopyright\space#4};%
      \end{tikzpicture}%
    }{\centering%
      \@afterindentfalse\@afterheading%
      #3}%
    \IfValueT{#2}{% Insert in \captionsetup inside the option warning from the `caption' package
      \captionsetup{type=graphic, font=footnotesize, textfont=it, %skip=2pt,
        format=plain, indention={1mm+.5em}, list=false}% To avoid "Unused \captionsetup[graphic]..."
      \captionof{graphic}{#2}%
    }%
  }%
}

%- Side graphic: environment for unmumbered figure or illustration (with or without a caption)
\NewDocumentCommand{\onesidegraphic}{s o m g}{% Built upon marginpar
  % Syntax − #1 = no star = copyright symbol, star = no copyright symbol
  %          #2 = caption text
  %          #3 = margin contents: an image file (or more) included with \includegraphics
  %          #4 = optional copyright/source of the graphic (graphics are different from figures)
  \leavevmode% https://tex.stackexchange.com/questions/395826 (That's the solution! Marvellous!)
  \marginpar{%
    \IfValueTF{#4}{%
      \stepcounter{graphiccount}%
      \graphictikzmark{\thegraphiccount}%
      %- Box height measurement is done with the same command used for margin ToC (see below)
      \begin{measurebox}[nobeforeafter]{\graphicboxheight}%, show bounding box
        \centering%
        \@afterindentfalse\@afterheading%
        #3%
      \end{measurebox}%
      \strictpagechecktrue%
      \checkoddpage%
      \ifbool{@reversemargin}{%
        \setlength{\graphicboxhshift}{\graphicboxheight}%% Inverting X and Y axes due to rotation
        \setlength{\graphicboxvshift}{5pt}%
        \renewcommand{\graphicside}{west}%
        \renewcommand{\graphicotherside}{east}%
        \renewcommand{\graphicrotateangle}{90}%
        \begin{tikzpicture}[remember picture,overlay]
          \node[%draw=red, thick,
            anchor=\graphicside,
            rotate around={\graphicrotateangle:(\thegraphiccount)},
            xshift=-\graphicboxhshift, 
            yshift=\graphicboxvshift,
            inner sep=0pt]
            (graphicbox\thegraphiccount)
            %at ([yshift=0pt]current page text area.\graphicotherside|-\thegraphiccount)
            at ([yshift=0pt]current page text area.\graphicside|-\thegraphiccount)
            {\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize\faCopyright\space#4}};%
            %{\scriptsize\faCopyright\space#4};%
        \end{tikzpicture}%
      }{\setlength{\graphicboxhshift}{\marginparwidth+5pt}%
        \setlength{\graphicboxvshift}{\graphicboxheight}%
        \renewcommand{\graphicside}{east}%
        \renewcommand{\graphicotherside}{west}%
        \renewcommand{\graphicrotateangle}{-90}%
        \begin{tikzpicture}[remember picture,overlay]
          \node[%draw=red, thick,
            anchor=\graphicside,
            rotate around={\graphicrotateangle:(\thegraphiccount)},
            xshift=-\graphicboxvshift,% Inverting X and Y axes due to rotation
            yshift=\graphicboxhshift,%\graphicboxvshift,
            inner sep=0pt]
            (graphicbox\thegraphiccount
            at ([yshift=0pt]current page text area.\graphicside|-\thegraphiccount)
            {\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize\faCopyright\space#4}};%
        \end{tikzpicture}%
      }%
    }{\centering%
      \@afterindentfalse\@afterheading%
      #3}%
    \IfValueT{#2}{% Insert in \captionsetup inside the option warning from the `caption' package
      \captionsetup{type=graphic, font=footnotesize, textfont=it, %skip=2pt,
        format=plain, indention={1mm+.5em}, list=false}% To avoid "Unused \captionsetup[graphic]..."
      \captionof{graphic}{#2}%
    }%
  }%
}

\NewDocumentCommand{\sideimage}{s o m g O{0pt}}{% Built upon marginnote
  % Syntax − #1 = no star = copyright symbol, star = no copyright symbol
  %          #2 = caption text
  %          #3 = margin contents: an image file (or more) included with \includegraphics
  %          #4 = optional copyright/source of the graphic (graphics are different from figures)
  %          #5 = optional voffset
  %\hspace{0pt}%
  \marginnote{%
    %\vspace*{\baselineskip}% compensate an unknown gap TODO: find the issue!
    \IfValueTF{#4}{%
      \stepcounter{graphiccount}%
      \graphictikzmark{\thegraphiccount}%
      %- Box height measurement is done with the same command used for margin ToC (see below)
      \begin{measurebox}[nobeforeafter]{\graphicboxheight}%, show bounding box
        \centering%
        \@afterindentfalse\@afterheading%
        #3%
      \end{measurebox}%
      \strictpagechecktrue%
      \checkoddpage%
      \ifoddpageoroneside%
        \setlength{\graphicboxhshift}{\marginparsep}%
        \setlength{\graphicboxvshift}{5pt}%
        \renewcommand{\graphicside}{west}%
        \renewcommand{\graphicotherside}{east}%
        \renewcommand{\graphicrotateangle}{90}%
      \else%
        \settowidth{\graphiccreditshift}{%
          \IfBooleanTF{#1}%
            {\scriptsize\space#4}%
            {\scriptsize\faCopyright\space#4}%
        }%
        %\setlength{\graphicboxhshift}{%
        %  -\marginparwidth-.5\marginparsep-.5\graphiccreditshift-0.4pt}%-0.8pt}%-1.6pt}% thick=0.8pt
        \setlength{\graphicboxhshift}{%
          -\marginparwidth-\marginparsep-\graphicboxheight+\graphiccreditshift}%
        \setlength{\graphicboxvshift}{\marginparwidth+5pt}%
        \renewcommand{\graphicside}{east}%
        \renewcommand{\graphicotherside}{west}%
        \renewcommand{\graphicrotateangle}{-90}%
      \fi%
      \begin{tikzpicture}[remember picture,overlay]
        \node[%draw=red, thick,
              anchor=\graphicside,
              %rotate=0,%\graphicrotateangle,
              rotate around={\graphicrotateangle:(\thegraphiccount)},
              xshift=\graphicboxhshift, yshift=\graphicboxvshift,
              inner sep=0pt]
          (graphicbox\thegraphiccount)
          at ([yshift=0pt]current page text area.\graphicotherside|-\thegraphiccount)
          {\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize\faCopyright\space#4}};%
          %{\scriptsize\faCopyright\space#4};%
      \end{tikzpicture}%
    }{\centering%
      \@afterindentfalse\@afterheading%
      #3}%
    \IfValueT{#2}{% Insert in \captionsetup inside the option warning from the `caption' package
      \captionsetup{type=graphic, font=footnotesize, textfont=it, %skip=2pt,
        format=plain, indention={1mm+.5em}, list=false}% To avoid "Unused \captionsetup[graphic]..."
      \captionof{graphic}{#2}%
    }%
  }[#5]%
}


\NewDocumentCommand{\onesideimage}{s o m g O{0pt}}{% Built upon marginnote
  % Syntax − #1 = no star = copyright symbol, star = no copyright symbol
  %          #2 = caption text
  %          #3 = margin contents: an image file (or more) included with \includegraphics
  %          #4 = optional copyright/source of the graphic (graphics are different from figures)
  %          #5 = optional voffset
  %\hspace{0pt}%
  \marginnote{%
    \IfValueTF{#4}{%
      \stepcounter{graphiccount}%
      \graphictikzmark{\thegraphiccount}%
      %- Box height measurement is done with the same command used for margin ToC (see below)
      \begin{measurebox}[nobeforeafter]{\graphicboxheight}%, show bounding box
        \centering%
        \@afterindentfalse\@afterheading%
        #3%
      \end{measurebox}%
      \strictpagechecktrue%
      \checkoddpage%
      \ifbool{@reversemargin}{%
        \setlength{\graphicboxhshift}{\graphicboxheight}%% Inverting X and Y axes due to rotation
        \setlength{\graphicboxvshift}{5pt}%
        \renewcommand{\graphicside}{west}%
        \renewcommand{\graphicotherside}{east}%
        \renewcommand{\graphicrotateangle}{90}%
        \begin{tikzpicture}[remember picture,overlay]
          \node[%draw=red, thick,
            anchor=\graphicside,
            rotate around={\graphicrotateangle:(\thegraphiccount)},
            xshift=-\graphicboxhshift, 
            yshift=\graphicboxvshift,
            inner sep=0pt]
            (graphicbox\thegraphiccount)
            %at ([yshift=0pt]current page text area.\graphicotherside|-\thegraphiccount)
            at ([yshift=0pt]current page text area.\graphicside|-\thegraphiccount)
            {\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize\faCopyright\space#4}};%
            %{\scriptsize\faCopyright\space#4};%
        \end{tikzpicture}%
      }{\setlength{\graphicboxhshift}{\marginparwidth+5pt}%
        \setlength{\graphicboxvshift}{\graphicboxheight}%
        \renewcommand{\graphicside}{east}%
        \renewcommand{\graphicotherside}{west}%
        \renewcommand{\graphicrotateangle}{-90}%
        \begin{tikzpicture}[remember picture,overlay]
          \node[%draw=red, thick,
            anchor=\graphicside,
            rotate around={\graphicrotateangle:(\thegraphiccount)},
            xshift=-\graphicboxvshift,% Inverting X and Y axes due to rotation
            yshift=\graphicboxhshift,%\graphicboxvshift,
            inner sep=0pt]
            (graphicbox\thegraphiccount
            at ([yshift=0pt]current page text area.\graphicside|-\thegraphiccount)
            {\IfBooleanTF{#1}{\scriptsize#4}{\scriptsize\faCopyright\space#4}};%
        \end{tikzpicture}%
      }%
    }{\centering%
      \@afterindentfalse\@afterheading%
      #3}%
    \IfValueT{#2}{% Insert in \captionsetup inside the option warning from the `caption' package
      \captionsetup{type=graphic, font=footnotesize, textfont=it, %skip=2pt,
        format=plain, indention={1mm+.5em}, list=false}% To avoid "Unused \captionsetup[graphic]..."
      \captionof{graphic}{#2}%
    }%
  }[#5]%
}

\ifbool{jazz@margin@usefrenchlanguage}{%
  \NewDocumentCommand{\sideremark}{ O{Remarque} m O{\faEye}}{%
    % Syntax #1 = optional title, #2 = mandatory text/stuff, #3 = optional symbol
    \marginelement{%
      \begin{tcolorbox}[
        colback = black!10,
        colbacktitle=black!10,% initially=black!50!white
        arc = 0pt, outer arc = 0pt,
        leftrule = 0pt, rightrule = 0pt,
        bottomrule = 0pt, toprule=0pt, boxrule = 0pt, boxsep = 0pt,% default=1mm
        left = 8pt, right = 8pt,% additional to boxsep, default=4mm
        top = 6pt, bottom = 6pt,% default=2mm
        toptitle = 6pt, bottomtitle = 0pt,
        title={\textcolor{secondcolor}{%
          \llap{\textcolor{firstcolor}{\normalsize#3}\space\hskip 10pt}%
          \spacedlowsmallcaps{\lightboldfont\normalsize#1}%
          \\[-.5\baselineskip]\rule{\linewidth}{1pt}}%
        },
      ]
      #2%
      \end{tcolorbox}%
    }
  }
}{\NewDocumentCommand{\sideremark}{ O{Note} m O{\faEye}}{%
    % Syntax #1 = optional title, #2 = mandatory text/stuff, #3 = optional symbol
    \marginelement{%
      \begin{tcolorbox}[
        colback = black!10,
        colbacktitle=black!10,% initially=black!50!white
        arc = 0pt, outer arc = 0pt,
        leftrule = 0pt, rightrule = 0pt,
        bottomrule = 0pt, toprule=0pt, boxrule = 0pt, boxsep = 0pt,% default=1mm
        left = 8pt, right = 8pt,% additional to boxsep, default=4mm
        top = 6pt, bottom = 6pt,% default=2mm
        toptitle = 6pt, bottomtitle = 0pt,
        title={\textcolor{secondcolor}{%
          \llap{\textcolor{firstcolor}{\normalsize#3}\space\hskip 10pt}%
          \spacedlowsmallcaps{\lightboldfont\normalsize#1}%
          \\[-.5\baselineskip]\rule{\linewidth}{1pt}}%
        },
      ]
      #2%
      \end{tcolorbox}%
    }
  }
}

%-- Side "fake float" as commands
%--------------------------------

%- Side figure
\NewDocumentCommand{\sidefigure}{o m}{%
  \FloatBarrier% process all floats before this point so the figure-like stuff numbers stay in order
  \marginelement{% \subcaptionbox et `subfigure' env. ne passent pas car pour flottants TODO: FIXME
    %\strictpagechecktrue\checkoddpage\ifoddpage\RaggedRight\else\RaggedLeft\fi%
    \setcounter{subfigure}{0}% Must reset the counter for "subSideFigure": WHY? FIXME
    %\centering%
    %\@afterindentfalse\@afterheading%
    %\vspace*{2pt}% compensate an unknown gap TODO: find the issue!
    %#2%
    %\IfValueT{#1}{\sidefigcaptionof{#1}}%
    \begin{minipage}{\marginparwidth}%
      \captionsetup*{type=figure, font=footnotesize,
        format=plain, indention={1mm+.5em}, list=false}%
      %\hbox{}\vspace*{#1}%
      \centering%
      \@afterindentfalse\@afterheading%
      #2%
      \IfValueT{#1}{\captionof{figure}{#1}}%
    \end{minipage}%
  }
  \IfValueT{#1}{\sidecaptionlist{figure}{#1}}%
}

%- Side table !!! For the record, use \subcaptionbox for subtable !!! (see `subcaption.sty')
\NewDocumentCommand{\sidetable}{o m}{%
  \marginelement{% \subcaptionbox et `subfigure' env. ne passent pas car pour flottants TODO: FIXME
    %\strictpagechecktrue\checkoddpage\ifoddpage\RaggedRight\else\RaggedLeft\fi%
    \begin{minipage}{\marginparwidth}%
      \captionsetup*{type=table, font=footnotesize,
        format=plain, indention={1mm+.5em}, list=false}%
      \IfValueT{#1}{\captionof{table}{#1}}%
      %\hbox{}\vspace*{#1}%
      \centering%
      \@afterindentfalse\@afterheading%
      #2%
    \end{minipage}%
  }
  \IfValueT{#1}{\sidecaptionlist{table}{#1}}%
}

% https://tex.stackexchange.com/questions/3657/get-the-size-that-a-figure-is-being-rendered


%- Side movie/video (full margin environment with the video counter)
\NewDocumentCommand{\sideVideo}{o m m D<>{\faVideoCamera}}{%
  %\FloatBarrier% process all floats before this point so the figure-like stuff numbers stay in order
  \marginelement{%
    %\strictpagechecktrue\checkoddpage\ifoddpage\RaggedRight\else\RaggedLeft\fi%
    %\refstepcounter{video}%
    \begin{minipage}{\marginparwidth}%
      \captionsetup*{type=video, font=footnotesize,
        format=plain, indention={1mm+.5em}, list=false}%
      %\hbox{}\vspace*{#1}%
      \centering%
      \@afterindentfalse\@afterheading%
      \href{run:#2}{#3}%
      \IfValueT{#1}{\captionof{video}{#1}}%
    \end{minipage}%
  }
  %\IfValueT{#1}{\sidecaptionlist{video}{#1}}%
  \IfValueT{#1}{%
    \IfNoValueTF{#4}%
      {\sidecaptionlist{video}{#1}}%
      {\sidecaptionlist{video}{#1\textcolor{secondcolor}{%
        \normalfont\footnotesize\ifblank{#4}{}{\enspace}#4}}}%
  }
}

%- Defining a side comment box similar to the side note command: numbering + pictogram + conditional
\newcommand{\commentmark}{\faIcon{comment-alt}}%\faComment
\newcommand{\commentfontsize}{\fontsize{4.0pt}{0pt}\selectfont}
\newlength{\commentmarkwidth}
\newlength{\commentmarkheight}
\settowidth{\commentmarkwidth}{\footnotesize\commentmark}
\settoheight{\commentmarkheight}{\footnotesize\commentmark}
\newcommand{\@commentsuperscript}[1]{% From latex.ltx \@textsuperscript
  %{\m@th\ensuremath{^{\mbox{\hspace*{-1pt}#1}}}}% Original (with math)
  \footnotesize\raisebox{0.20\baselineskip}{\hspace*{-0.75pt}#1\hspace*{-1.5pt}}%
}
\ExplSyntaxOn
\newcounter{sidecomment} % make a counter
%\setcounter{sidecomment}{1} % init the counter − Original
%\setcounter{sidecomment}{0} % init the counter: not needed with our modifications
\NewDocumentCommand{\@sidecomments@thesidecommentmark}{ m }{% See latex.ltx \@footnotemark def.
  \leavevmode
  \ifhmode\edef\@x@sf{\the\spacefactor}\nobreak\fi
  %\hbox {\@textsuperscript {\normalfont #1 }}% Original
  \hbox{% See latex.ltx \@makefnmark def.
    \@commentsuperscript{%
      \color{firstcolor}%
      \footnotesize\commentmark\hspace*{-\commentmarkwidth}%
      \makebox[\commentmarkwidth][c]{%
        \raisebox{0.375\commentmarkheight}{%
          \commentfontsize\textcolor{white}{\textbf{\thesidecomment}}%
        }%
      }%
    }%
  }%
  \ifhmode\spacefactor\@x@sf\fi
  \relax
}
\NewDocumentCommand{\@sidecomments@multisign}{ }{3sp}
\NewDocumentCommand{\@sidecomments@multimarker}{ }{%
  \kern-\@sidecomments@multisign
  \kern\@sidecomments@multisign\relax
}
\NewDocumentCommand{\@sidecomments@multichecker}{ }{%
  \dim_compare:nNnTF \lastkern = \@sidecomments@multisign
  {\@sidecomments@thesidecommentmark{,}}
  %{}% Original: no extra space between text and note numbering
  {\hspace*{0.5pt}}% Adding a small space between text and note numbering
}
\NewDocumentCommand{\@sidecomments@placemarginal}{ m m }{%
  \IfNoValueOrEmptyTF{#1}
    {\marginpar{#2}}
    {\marginnote{#2}[#1]}
}
\NewDocumentCommand{\sidecomment}{ o o +m }{%
  \sidecommentmark[#1]
  \sidecommenttext[#1][#2]{#3}
  \@sidecomments@multimarker
}
\NewDocumentCommand{\sidecommentmark}{ o }{%
  \@sidecomments@multichecker
  \IfNoValueOrEmptyTF{#1}
    {\@sidecomments@thesidecommentmark{\thesidecomment}}
    {\@sidecomments@thesidecommentmark{#1}}
  \@sidecomments@multimarker
}
\NewDocumentCommand{\sidecommenttext}{ o o +m }{%
  \IfNoValueOrEmptyTF{#1}{%
    %\@sidecomments@placemarginal{#2}{\textsuperscript{\thesidecomment}{}~\footnotesize#3}% Original
    \@sidecomments@placemarginal{#2}{% French layout
      %\footnotesize\textcolor{secondcolor}{\thesidecomment.\:}#3%
      \footnotesize\textcolor{secondcolor}{\thesidecomment.~}#3%
    }%
    \refstepcounter{sidecomment}
  }{%
    \@sidecomments@placemarginal{#2}{\textsuperscript{#1}~\footnotesize#3}% To be modified
  }
}
%- Following the idea from: https://tex.stackexchange.com/questions/434023/reference-to-sidenote
%- some adjustments have to be done to \sidenotetext and \sidenote
\RenewDocumentCommand{\sidecomment}{ o o +m }{%
  \@sidecomments@multichecker
  \sidecommenttext[#1][#2]{#3}
  \sidecommentmark[#1]
  \@sidecomments@multimarker
}
\RenewDocumentCommand{\sidecommenttext}{ o o +m }{%
  \IfNoValueOrEmptyTF{#1}{%
    \refstepcounter{sidecomment}
    \@sidecomments@placemarginal{#2}{% French layout
      \textcolor{firstcolor}{%
        \llap{%
          \footnotesize\commentmark\hspace*{-\commentmarkwidth}%
          \makebox[\commentmarkwidth][c]{%
            \raisebox{0.375\commentmarkheight}{%
              \commentfontsize\textcolor{white}{\textbf{\thesidecomment}}%
            }%
          }%
          \hspace*{3pt}%
        }%
      }\footnotesize#3%
    }%
  }{%
    \@sidecomments@placemarginal{#2}{%
      \textsuperscript{#1}~\footnotesize#3}% To be modified
  }
}
\ExplSyntaxOff


\newlength{\insertboxheight}
\setlength{\insertboxheight}{4pt}% Just an initialization

\DeclareTColorBox{jazzmarginbox}{ o }{%
  width=\marginparwidth,
  enhanced,
  nobeforeafter,
  arc=0pt, outer arc=0pt,
  boxsep=0pt,
  left=5pt, right=5pt,
  top=8pt, bottom=4pt,
  boxrule=0pt,
  colback=black!8,
  %colframe=black!40,
  fontupper=\normalfont\footnotesize,
  IfValueTF={#1}{%
    before upper*={% Without star: spurious leading vertical space. WHY?
      \textcolor{secondcolor}{\normalsize\spacedlowsmallcaps{#1}}%
      \par\vspace*{-.5\baselineskip}%
      \textcolor{secondcolor}{\rule{\linewidth}{1pt}}%
      \par\vspace*{2pt}%
    },
  }{},%
}

\NewDocumentCommand{\sideinsert}{o m}{%
  % Usage: #1 = optional title; #2 = stuff/text to include
  \marginnote{%
    \vspace*{-\baselineskip}% Needed manual empirical shift! WHY?
    \begin{measurebox}{\insertboxheight}
      \begin{jazzmarginbox}[#1]
        %\ignorespaces%
        #2%
      \end{jazzmarginbox}%
    \end{measurebox}
  }%\unskip%
  \mparshift{\insertboxheight}% Shifting down the next margin notes (from `marginfix' package)
  \marginpar{\vspace*{\baselineskip}}% More space: starts next display at the correct position
}

% Experimental!!!
%----------------

%- Side core
\newcounter{sidecore}% make a counter
%\renewcommand{\thesidecore}{\fnsymbol{sidecore}}
\renewcommand{\thesidecore}{\alph{sidecore}}
%\renewcommand{\thefootnote}{\alph{footnote}}
\def\@makesidecoremark{%
  \hbox{\@textsuperscript{\normalfont\textcolor{secondcolor}{\itshape\@thesidecoremark}}}%
}
\def\sidecoremark{%
  \@ifnextchar[\@xsidecoremark
    {\stepcounter{sidecore}%
    \protected@xdef\@thesidecoremark{\thesidecore}%
    \@sidecoremark}}
\def\@xsidecoremark[#1]{%
  \begingroup
    \c@sidecore #1\relax
      \unrestored@protected@xdef\@thesidecoremark{\thesidecore}%
  \endgroup
  \@sidecoremark}
\def\@sidecoremark{%
  \leavevmode
  \ifhmode\edef\@x@sf{\the\spacefactor}\nobreak\fi
  \@makesidecoremark
  \ifhmode\spacefactor\@x@sf\fi
  \relax}
\DeclareDocumentCommand{\sidecore}{O{secondcolor} m}{% Old fashion but works with just above stuff
  {%
    \hypersetup{linkcolor=secondcolor}% There is a bug with hyperlinks: wrong page key
    \sidecoremark%
  }%
  \ignorespaces%
  %\marginnote{%
  \marginpar{%
    \justifying\footnotesize%
    \textcolor{#1}{\thesidecore.{\:}}%
    \ignorespaces%
    #2%
  }%
}




















































