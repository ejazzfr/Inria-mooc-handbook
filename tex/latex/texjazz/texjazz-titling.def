%%
%% texjazz-titling.def
%%
%% A LaTeX file to configure sectionning and titling instructions.
%%
%% Copyright (c) 2020-2021 ejazz.
%%
% --------------------------------------------------------------------------------------------------
% This work is part of the TeXjazz bundle. It may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% The Current Maintainer of this work is ejazz <ejazz.fr@gmail.com>.
%
% This work consists of the files:
%     `texjazz-titling.def' and `texjazz-titling[-fr].tex' (not yet fully available).
% --------------------------------------------------------------------------------------------------

%-- File identification
%----------------------

\ProvidesFile{texjazz-titling.def}%
  [2021/02/08 v0.1a − Configuring the section titles]

\newbool{titling@usefrenchlanguage}% To be extended for compliance with language packages
\booltrue{titling@usefrenchlanguage}

%-- Document management
%----------------------

%- The "lightboldfont" comes from textjazz-handbook
\ifcsdef{lightboldfont}{}{\let\lightboldfont\bfseries}

%- The "coding@article" comes from textjazz-handbook "doc@article"
\newbool{titling@article}
\ifcsdef{chapter}{\boolfalse{titling@article}}{\booltrue{titling@article}}
\newbool{titling@appendixchapter}
\ifcsdef{appendixchapter}{\booltrue{titling@appendixchapter}}{\boolfalse{titling@appendixchapter}}


%-- Powerful tool redefining LaTeX sectioning commands (a rather difficult code to understand)
%- option: loading `titleps' for header and footer (see next §)
\RequirePackage[pagestyles,newparttoc]{titlesec}


%- Numbering typesetting / Composition de la numérotation (à modifier selon convenances)
\renewcommand{\thepart}{\Roman{part}}% default is Roman
\ifbool{titling@article}
  {}
  {\renewcommand{\thechapter}{\arabic{chapter}}}
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
\renewcommand{\thesubsubsection}{\thesubsection.\arabic{subsubsection}}
\renewcommand{\theparagraph}{\roman{paragraph}}
\renewcommand{\thesubparagraph}{\alph{subparagraph}}


%- Chapter layout initializing with the `titlesec' macro (Remove default 50pt vertical shift)
\def\ttl@mkchap@i#1#2#3#4#5#6#7{%
  \ttl@assign\@tempskipa#3\relax\beforetitleunit
  \vspace{\@tempskipa}%<<<<<< REMOVE THE * AFTER \vspace: this is the KEY POINT!
  \global\@afterindenttrue
  \ifcase#5 \global\@afterindentfalse\fi
  \ttl@assign\@tempskipb#4\relax\aftertitleunit
  \ttl@topmode{\@tempskipb}{%
    \ttl@select{#6}{#1}{#2}{#7}}%
  \ttl@finmarks  % Outside the box!
  \@ifundefined{ttlp@#6}{}{\ttlp@write{#6}}
}

%-- Sectionning layouts
%----------------------
%- This approach comes from the use of the implicit option of the `titlesec' package AND also to
%- record a second ToC into the file jobname.tdm (tdm stands for "table des matières" in French).
%- This second ToC is necessary to be able to have different layouts for the main and partial ToCs.
%---

%- Layout lengths (transitional help)
\newlength{\secLabelWidth}% adjusting label width / horizontal space
\newlength{\secLabelHeigth}% adjusting label heigth / vertical space
\newlength{\secLabelDepth}% adjusting label depth / vertical space
\newlength{\secLabelGap}
\newlength{\secTitleHeigth}
\newlength{\secTitleDepth}
\newlength{\secLabelSep}
\setlength{\secLabelSep}{\parindent}
\newlength{\chapterHeaderHeigth}
\setlength{\chapterHeaderHeigth}{9.5cm}

%- Utilities
\newcommand{\noHyphen}{\hyphenpenalty10000\exhyphenpenalty10000\righthyphenmin62\lefthyphenmin62}

%https://tex.stackexchange.com/questions/117222/
%(issue-with-titlesec-page-styles-and-appendix-in-book-class)
%\newtitlemark{\chaptertitlename}

%- Take care that `polyglossia/gloss-french.ldf' package sets \partname to empty: \def\partname{}
\newcommand*{\jazzpartname}{partie}

%- Parts: adding new counter 'jazzpart' to have "Deuxième vs Seconde" for ToC/TdM parts (see below)
\newtotcounter{jazzpart}% To select 'Deuxième' if max part > 2 or 'Seconde' if max part = 2

%- Modifying ordinal numbering to better fit French convention:
%- if only two parts -> 'Seconde partie' instead of 'Deuxième partie'
\newcommand{\frenchtextnumberpart}[1]{% #1 = jazzpart counter (féminin : partie)
  \ifcase\value{#1}\or Première\or
    \ifnum\totvalue{jazzpart} > 2 Deuxième\else Seconde\fi\or
    Troisième\or Quatrième\or Cinquième\or Sixième\or
    Septième\or Huitième\or Neuvième\or Dixième\or Onzième\or
    Douzième\or Treizième\or Quatorzième\or Quinzième\or
    Seizième\or Dix-septième\or Dix-huitième\or Dix-neuvième\or Vingtième
  \fi%\space
}

%---
%- Below the following macros are coming from the `geometry' package:
%- `\Gm@lmargin}' `\Gm@rmargin}' `\Gm@tmargin}' `\Gm@bmargin}'
%- For the record, to verify and display lengths one can use:
%- a. \the\dimexpr\hoffset+\oddsidemargin\relax (\dimexpr is an eTeX macro)
%- b. \the\chapterHeaderHeigth
%---
%- Numbered part layout
\newcommand{\numberedPartLayout}[1]{%
  \begin{tikzpicture}[remember picture, overlay]
    %- Main page background rectangle
    \fill[maincolor, fill opacity=1] (current page.north west) rectangle (current page.south east);
    %- Bottom header rectangle
    \fill[maincolor, fill opacity=1] (current page.south west) rectangle
      ([yshift=\footskip]current page.south east);
    %- Separation lines
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\chapterHeaderHeigth]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\Gm@tmargin]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=south west] at
      ([yshift=\footskip]current page.south west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    %- Part title
    %\node[inner sep=0pt, anchor=east, font=\fontsize{50pt}{60pt}\selectfont\titlefont]
    %  (title) at ([yshift=-.4\chapterHeaderHeigth]current page marginpar area.north east)
    %  {\begin{varwidth}{\entirewidth}\FlushRight\noHyphen\textcolor{secondcolor}{#1}\end{varwidth}};
    %\pagebookmark[level=-1]{part:\thepart}{Coucou ! Partie : \thepart}%
    \node[inner sep=0pt, anchor=east, font=\fontsize{50pt}{60pt}\selectfont\titlefont]
      (title) at ([yshift=-.4\chapterHeaderHeigth]current page marginpar area.north east) {%
        \noHyphen\textcolor{secondcolor}{#1}%
      };
    %\pagebookmark[level=-1]{part:\thepart}{Coucou ! Partie : \thepart}
    %- Part label and numbering - Take care that French Polyglossia sets \partname to empty!!!
    \node[inner sep=0pt, anchor=north east] (label) at
      ([yshift=-10pt]current page marginpar area.north east)
        %- Display "Seconde partie" in French if only two parts (jazzpart counter is total)
        {\normalfont\huge\textcolor{white}{\textsc{\frenchtextnumberpart{part} \jazzpartname}}};%
    \node[anchor=west] at
      ([xshift=-1.05\entirewidth,yshift=-.4\chapterHeaderHeigth]current page marginpar area.north east)
        %{\color{firstcolor}\fontsize{150}{180}\sffamily\bfseries\@Roman\c@part};% A little bit too big
        %{\color{firstcolor}\fontsize{130}{144}\sffamily\bfseries\@Roman\c@part};% Still too big in some cases
        %{\color{firstcolor}\fontsize{110}{132}\sffamily\bfseries\@Roman\c@part};
        {\color{firstcolor}\fontsize{100}{120}\sffamily\bfseries\@Roman\c@part};
    %- Partial part ToC: only chapters and sections
    \node[anchor=south east] at
      ([xshift=0.0\entirewidth,yshift=-0pt]current page marginpar area.south east)
        %{\parbox[b][][b]{\entirewidth}{% \parbox or minipage MUST BE used
        %  \hypersetup{linkcolor=white}
        %  \color{firstcolor}\printcontents[parts]{p}{0}{\setcounter{tocdepth}{1}}}};
        {\hypersetup{linkcolor=white}
         \begin{minipage}{.6\entirewidth}%
           \color{firstcolor}\printcontents[parts]{p}{0}{\setcounter{tocdepth}{0}}%
           %\par\Large Partie : \thepart \qquad Jazzpart : \thejazzpart% Test
         \end{minipage}
        };
    %- Book title in footer
    \node[inner sep=0pt, anchor=south] at ([yshift=.5\footskip]current page.south)
        {\small\color{secondcolor}
          \spacedsmallcaps{\@doctitle}
          \ifdefempty{\@doctitle}{}{\ifdefempty{\@subtitle}{}{ \textemdash{} }}\textsc{\@subtitle}
          \ifdoc@license% adding licence information if needed
            \ifdefempty{\@copyrightname}{}{\quad\@copyrightsymbol\ }\@copyrightname
            \ifdefempty{\@versiondate}{}{ \textendash{} }\@versiondate
            \ifdefempty{\@docversion}{}{\ifdefempty{\@versiondate}{ \textendash{} }{, }}\@docversion
          \fi};%
  \end{tikzpicture}
}
%- Unumbered part layout
\newcommand{\numberlessPartLayout}[1]{%
  \begin{tikzpicture}[remember picture, overlay]
    %- Main page background rectangle
    \fill[maincolor, fill opacity=1] (current page.north west) rectangle (current page.south east);
    %- Bottom header rectanglegadgets
    \fill[maincolor, fill opacity=1] (current page.south west) rectangle
      ([yshift=\footskip]current page.south east);
    %- Separation lines
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\chapterHeaderHeigth]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\Gm@tmargin]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=south west] at
      ([yshift=\footskip]current page.south west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    %- Part title
    %\node[inner sep=0pt, anchor=east, font=\fontsize{50pt}{60pt}\selectfont\titlefont]
    %  (title) at ([yshift=-.4\chapterHeaderHeigth]current page marginpar area.north east)
    %  {\begin{varwidth}{\entirewidth}\FlushRight\noHyphen\textcolor{secondcolor}{#1}\end{varwidth}};
    \node[inner sep=0pt, anchor=east, font=\fontsize{50pt}{60pt}\selectfont\titlefont]
      (title) at ([yshift=-.4\chapterHeaderHeigth]current page marginpar area.north east)
      {\noHyphen\textcolor{secondcolor}{#1}};
    %- Book title in footer
    \node[inner sep=0pt, anchor=south] at ([yshift=.5\footskip]current page.south)
        {\small\color{secondcolor}
          \spacedsmallcaps{\@doctitle}
          \ifdefempty{\@doctitle}{}{\ifdefempty{\@subtitle}{}{ \textemdash{} }}\textsc{\@subtitle}
          \ifdoc@license% adding licence information if needed
            \ifdefempty{\@copyrightname}{}{\quad\@copyrightsymbol\ }\@copyrightname
            \ifdefempty{\@versiondate}{}{ \textendash{} }\@versiondate
            \ifdefempty{\@docversion}{}{\ifdefempty{\@versiondate}{ \textendash{} }{, }}\@docversion
          \fi};%
  \end{tikzpicture}
}
%- Numbered chapter layout
\newcommand{\numberedChapterLayout}[1]{%
  \begin{tikzpicture}[remember picture, overlay]
    %- Main header rectangle
    \fill[maincolor, fill opacity=1]
      ([yshift=-\Gm@tmargin]current page.north west) rectangle
      ([yshift=-\chapterHeaderHeigth]current page.north east);
    %- Bottom header rectangle
    \fill[maincolor, fill opacity=1] (current page.south west) rectangle
      ([yshift=\footskip]current page.south east);
    %- Separation lines
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\chapterHeaderHeigth]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\Gm@tmargin]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=south west] at
      ([yshift=\footskip]current page.south west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    %- Chapter title
    \node[inner sep=0pt, anchor=south west,
          font=\fontsize{50pt}{60pt}\selectfont\titlefont] (title) at
          ([yshift=-.8\chapterHeaderHeigth]current page text area.west|-current page.north)
          {\begin{varwidth}{\entirewidth}%
            \FlushLeft%
            \noHyphen\textcolor{secondcolor}{#1}%
          \end{varwidth}};
    %- Chapter label and numbering
    \node[inner sep=10pt, anchor=south] (label) at (current page marginpar area.north)
        {\normalfont\huge\textcolor{firstcolor}{\textsc{\chaptertitlename}~\thechapter}};
    %- Book title in footer
    \node[inner sep=0pt, anchor=south east] at
      ([xshift=\marginparsep+\marginparwidth,
        yshift=-.5\footskip]current page footer area.south east)
        {\small\color{white}
          \spacedsmallcaps{\@doctitle}
          \ifdefempty{\@doctitle}{}{\ifdefempty{\@subtitle}{}{ \textemdash{} }}\textsc{\@subtitle}
          \ifdoc@license% adding licence information if needed
            \ifdefempty{\@copyrightname}{}{\quad\@copyrightsymbol\ }\@copyrightname
            \ifdefempty{\@versiondate}{}{ \textendash{} }\@versiondate
            \ifdefempty{\@docversion}{}{\ifdefempty{\@versiondate}{ \textendash{} }{, }}\@docversion
          \fi};%
  \end{tikzpicture}
}
%- Unnumbered chapter layout
\newcommand{\numberlessChapterLayout}[1]{%
  \begin{tikzpicture}[remember picture, overlay]
    %- Main header rectangle
    \fill[maincolor, fill opacity=1]
      ([yshift=-\Gm@tmargin]current page.north west) rectangle
      ([yshift=-\chapterHeaderHeigth]current page.north east);
    %- Bottom header rectangle
    \fill[maincolor, fill opacity=1] (current page.south west) rectangle
      ([yshift=\footskip]current page.south east);
    %- Separation lines
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\chapterHeaderHeigth]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\Gm@tmargin]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=south west] at
      ([yshift=\footskip]current page.south west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    %- Chapter title
    \node[inner sep=0pt, anchor=south west,
          font=\fontsize{50pt}{60pt}\selectfont\titlefont] (title) at
          ([yshift=-.8\chapterHeaderHeigth]current page text area.west|-current page.north)
          {\begin{varwidth}{\entirewidth}%
            \FlushLeft%
            \noHyphen\textcolor{secondcolor}{#1}%
          \end{varwidth}};
    %- Book title in footer
    \node[inner sep=0pt, anchor=south east] at
      ([xshift=\marginparsep+\marginparwidth,
        yshift=-.5\footskip]current page footer area.south east)
        {\small\color{white}
          \spacedsmallcaps{\@doctitle}
          \ifdefempty{\@doctitle}{}{\ifdefempty{\@subtitle}{}{ \textemdash{} }}\textsc{\@subtitle}
          \ifdoc@license% adding licence information if needed
            \ifdefempty{\@copyrightname}{}{\quad\@copyrightsymbol\ }\@copyrightname
            \ifdefempty{\@versiondate}{}{ \textendash{} }\@versiondate
            \ifdefempty{\@docversion}{}{\ifdefempty{\@versiondate}{ \textendash{} }{, }}\@docversion
          \fi};%
  \end{tikzpicture}
}
%- Sections
\newcommand{\sectionLayout}[1]{%
  % Automatically added by redefined \ttl@addcontentsline (see above)
  %  \addcontentsline{tdm}{section}{\protect\numberline{\thesection}#1}%
  \raisebox{\secLabelGap}[0pt][0pt]{%
    \parbox[c]{\linewidth-\secLabelSep}{\Large\titlingfont\color{titlingcolor}#1}%
  }%
}
%- Subsections
\newcommand{\subsectionLayout}[1]{%
  \raisebox{\secLabelGap}[0pt][0pt]{\large\titlingfont\color{titlingcolor}#1}}
  %\large\titlingfont\color{titlingcolor}#1}
%- Subsubsections
\newcommand{\subsubsectionLayout}[1]{%
  \raisebox{\secLabelGap}[0pt][0pt]{\normalsize\titlingfont\color{titlingcolor}#1}}
  %\normalsize\titlingfont\color{titlingcolor}#1}
%- Paragraphs
\newcommand{\paragraphLayout}[1]{%
  \titlingspacedfont\spacedlowsmallcaps{#1}}
%- Subparagraphs
\newcommand{\subparagraphLayout}[1]{%
  \spacedlowsmallcaps{#1}}

%-- Sectionning display

%- ToC multicolums setup (tricky to automatically tune: see doc. and TeX.SE links above)
\newcommand{\setuptocmulticols}{%
  %- Setting multicolumns parameters (see the `multicol' package documentation)
  \protect\setlength{\columnsep}{-24pt}%
  \protect\setlength{\columnseprule}{0pt}%{.4pt} No need of column separation
  \protect\raggedcolumns% Default = \flushcolumns INDISPENSABLE POUR ALIGNEMENT CORRECT COLONNES !
  %\protect\tolerance=200% Default = 200 → TeX \fussy, \sloppy → = 10000
  %\protect\multicoltolerance=9999% Default = 9999
  %\protect\setlength{\multicolovershoot}{1pt}% Default = 0pt, stretch tolerance of the column height
  %\protect\setlength{\multicolundershoot}{2pt}% Default = 2pt, shrink tolerance of the column height
  %\protect\setlength{\maxbalancingoverflow}{24pt}% Default = 12pt
  %\protect\setcounter{columnbadness}{9999}% Default = 10000
  %\protect\setcounter{finalcolumnbadness}{9999}% Default = 9999
  \protect\setcounter{collectmore}{-1}% Default = 0; Global → has to bet reset
  %\protect\setcounter{unbalance}{2}% Local → reset automatically to zero after the environment
  \protect\setcounter{multicolminlines}{1}% Min. numb. of lines: \baselineskip (auto reset)
}
%- ToC multicolums resetting (to ensure that the settings don't propagate)
\newcommand{\resettocmulticols}{%
  %\protect\raggedcolumns% Default = \flushcolumns
  %\protect\tolerance=200% Default = 200 → TeX \fussy, \sloppy → = 10000
  %\protect\multicoltolerance=9999% Default = 9999
  %\protect\setlength{\multicolovershoot}{1pt}% Default = 0pt, stretch tolerance of the column height
  %\protect\setlength{\multicolundershoot}{3pt}% Default = 2pt, shrink tolerance of the column height
  %\protect\setlength{\maxbalancingoverflow}{14pt}% Default = 12pt
  %\protect\setcounter{columnbadness}{9999}% Default = 10000
  %\protect\setcounter{finalcolumnbadness}{9999}% Default = 9999
  \protect\setcounter{collectmore}{0}% Default = 0; Global → has to bet reset
  %\protect\setcounter{unbalance}{2}% Local → reset automatically to zero after the environment
  %\protect\setcounter{multicolminlines}{2}% Min. numb. of lines: \baselineskip
}

%- Part and chapter layout
\ifbool{titling@article}{}{%
  %- Adding a new counter jazzpart for Deuxième vs Seconde in ToC/TdM: VERY STRANGE BUT WORKS!
  \titleformat{\part}[display]{}{}{0pt}{%
    %\addtocounter{jazzpart}{1}% NO, NOT HERE!!!
    \numberedPartLayout}
    % THE FOLLOWING MUST BE DONE TO HAVE THE PART NUMBER DISPLAYING IN THE TOC/TDM!
    % See e.g. https://tex.stackexchange.com/questions/414493/[...]
    %   [...]failure-of-if-condition-inside-titlecontents
    [\ifnum\value{part}>0
       \addtocontents{toc}{\protect\addtocounter{jazzpart}{1}}%
       \addtocontents{tdm}{\protect\addtocounter{jazzpart}{1}}%
     \fi
    ]
  \titleformat{name=\part,numberless}[display]{}{}{0pt}{\numberlessPartLayout}[]
  \titlespacing*{\part}{0pt}{0pt}{0pt}
  %- Chapters: two columns main ToC display of the sections
  %\renewcommand{\columnseprulecolor}{\color{secondcolor}
  \titleformat{\chapter}[display]{}{}{0pt}{\numberedChapterLayout}
    [% Chapter after code to display ToC (sub)sections in two columns for mainmatter
      \ifnum\value{chapter}>0
        \addtocontents{tdm}{%
          \protect\vspace{\aftertocchapterspace}%
          \protect\setuptocmulticols\protect\begin{tocmulticols}{2}\protect\multicolsusedtrue}%
        %\addtocontents{lof}{%
        %  \protect\vspace{\afterlofchapterspace}}%
      \fi%
     % Deleting spurious spaces for LoF, LoT, LoE, LoV, LoD
      %\addtocontents{lof}{\protect\addvspace{-\baselineskip}}
      %\addtocontents{lot}{\protect\addvspace{-\baselineskip}}
      %\addtocontents{lod}{\protect\addvspace{-\baselineskip}}
      %\addtocontents{loe}{\protect\addvspace{-\baselineskip}}
      %\addtocontents{lov}{\protect\addvspace{-\baselineskip}}
    ]
  \titleformat{name=\chapter,numberless}[display]{}{}{0pt}{\numberlessChapterLayout}[]
  \titlespacing*{\chapter}{0pt}{0pt}{\chapterHeaderHeigth+1.5cm-\Gm@tmargin-40pt}
}

%- Sections
\titleformat{\section}
  [hang]% shape
  {}% format applied to label+text
  {%
    \fontsize{1.6cm}{1.8cm}%
    \sectionnumberfont\color{titlingnumbercolor}%
    \setlength{\secLabelWidth}{\widthof{\textsc{\thesubsection}}}%
    \setlength{\secLabelHeigth}{\heightof{\textsc{\thesubsection}}}%
    \setlength{\secLabelDepth}{\depthof{\textsc{\thesubsection}}}%
    \ifdoc@sectionappendix%
      \setlength{\secLabelGap}{.75\secLabelHeigth}%\secLabelDepth}%
    \else%
      \setlength{\secLabelGap}{\secLabelHeigth}%
      %\setlength{\secLabelGap}{\secLabelHeigth-\secLabelDepth}%
    \fi%
    \global\secLabelGap=\secLabelGap% Assignments of lengths are local by default
    \llap{\raisebox{\secLabelGap-3mm}[0pt][0pt]{%
      \textsc{\thesection}}\hspace*{-.125\secLabelWidth}}%
    %\rlap{\hspace*{-0.6\secLabelWidth}\raisebox{-3mm}[0pt][0pt]{\textsc{\thesection}}}%
  }% label
  {\secLabelSep}% horizontal (with hang) separation between label and title body
  {\sectionLayout}% implicit {#1} before the title body
  [\vspace*{-\secLabelGap}\vspace*{-3mm}]% after the title body
\titleformat{name=\section,numberless}
  [hang]% shape
  {}% format applied to label+text
  {}% label
  {0pt}% horizontal (with hang) separation between label and title body
  {\Large\titlingfont\color{titlingcolor}}% implicit {#1} before the title body
  []% after the title body
%- Subsections
\titleformat{\subsection}
  [hang]% shape block?
  {}% format applied to label+text
  {\fontsize{.8cm}{1cm}%
    \sectionnumberfont\color{titlingnumbercolor}%
    \setlength{\secLabelWidth}{\widthof{\textsc{\thesubsection}}}%
    \setlength{\secLabelHeigth}{\heightof{\textsc{\thesubsection}}}%
    \setlength{\secLabelDepth}{\depthof{\textsc{\thesubsection}}}%
    %\setlength{\secLabelGap}{\secLabelHeigth-\secLabelDepth}%
    \setlength{\secLabelGap}{.75\secLabelHeigth}%
    \global\secLabelGap=\secLabelGap% Assignments of lengths are local by default
    \llap{\raisebox{\secLabelGap-1mm}[0pt][0pt]{%
      \textsc{\thesubsection}}\hspace*{-.35\secLabelWidth}}%
    %- First displaying attempt (no vertical correction for section at start of new page)
    %\llap{\raisebox{-1mm}[0pt][0pt]{\textsc{\thesubsection}}\hspace*{-.35\secLabelWidth}}%
    %\rlap{\hspace*{-.65\secLabelWidth}\raisebox{-1mm}[0pt][0pt]{\textsc{\thesubsection}}}%
  }% label
  %{\textsc{\MakeTextLowercase{\thesubsection}}}% label
  {\secLabelSep}% horizontal (with hang) separation between label and title body
  {\subsectionLayout}% implicit {#1} before the title body
    %{\large 2.3}\subsectionLayout}% implicit {#1} before the title body
  [\vspace*{-\secLabelGap}\vspace*{-1mm}]% after the title body
\titleformat{name=\subsection,numberless}
  [hang]% shape
  {}% format applied to label+text
  {}% label
  {0pt}% horizontal (with hang) separation between label and title body
  {\large\titlingfont\color{titlingcolor}}% implicit {#1} before the title body
  %{\scalebox{1.075}{\titlingfont\normalsize\color{titlingcolor}}}% {#1}before the title body
  []% after the title body
%- Subsubsections
\titleformat{\subsubsection}
  [hang]% shape
  {}% format applied to label+text
  {\fontsize{.6cm}{.8cm}%
    \sectionnumberfont\color{titlingnumbercolor}%
    \setlength{\secLabelWidth}{\widthof{\textsc{\thesubsection}}}%
    \setlength{\secLabelHeigth}{\heightof{\textsc{\thesubsection}}}%
    \setlength{\secLabelDepth}{\depthof{\textsc{\thesubsection}}}%
    \setlength{\secLabelGap}{\secLabelHeigth-\secLabelDepth}%
    \global\secLabelGap=\secLabelGap% Assignments of lengths are local by default
    \llap{\raisebox{\secLabelGap-.5mm}[0pt][0pt]{%
      \textsc{\thesubsubsection}}\hspace*{-.5\secLabelWidth}}%
    %\llap{\raisebox{-.5mm}[0pt][0pt]{\textsc{\thesubsubsection}}\hspace*{-.5\secLabelWidth}}%
    %\rlap{\hspace*{-1.25\secLabelWidth}\raisebox{-.5mm}[0pt][0pt]{\textsc{\thesubsubsection}}}%
  }% label
  {\secLabelSep}% horizontal (with hang) separation between label and title body
  {\subsubsectionLayout}% implicit {#1} before the title body
  %{\scalebox{1.075}{\titlingfont\normalsize\color{titlingcolor}}}% {#1}before the title body
  [\vspace*{-\secLabelGap}\vspace*{-.5mm}]% after the title body
\titleformat{name=\subsubsection,numberless}
  [hang]% shape
  {}% format applied to label+text
  {}% label
  {0pt}% horizontal (with hang) separation between label and title body
  {\normalsize\titlingfont\color{titlingcolor}}% implicit {#1} before the title body
  %{\scalebox{1.075}{\titlingfont\normalsize\color{titlingcolor}}}% {#1}before the title body
  []% after the title body
%- Paragraphs
\titleformat{\paragraph}
  [runin]% shape
  {\titlingfont}% format applied to label+text
  {\llap{\color{titlingnumbercolor}\theparagraph\,\textendash\space}}% label
  {0pt}% horizontal (with runin) separation between label and title body
  {\paragraphLayout}% implicit {#1} before the title body
  [\normalfont\normalsize\enspace\textemdash{}\enspace]% after the title body
\titleformat{name=\paragraph,numberless}
  [runin]% shape
  {\titlingfont}% format applied to label+text
  {\theparagraph}% label (cf. doc le déclarer quand même)
  {0pt}% horizontal (with runin) separation between label and title body
  {\titlingspacedfont\spacedlowsmallcaps}% {#1}before the title body
  [\normalfont\normalsize\enspace\textemdash{}\enspace]% after the title body
%- Subparagraphs
\titleformat{\subparagraph}%
  [runin]% shape
  {\normalfont\normalsize\sffamily\itshape}% format applied to label+text
  {\thesubparagraph.}% label
  %{\textsc{\MakeTextLowercase{\thesubparagraph}}}% label
  {4pt}% horizontal (with runin) separation between label and title body
  %{\titlingspacedfont\scshape}% {#1}before the title body
  {\subparagraphLayout}% {#1}before the title body
  [\space\textemdash\space\normalfont\normalsize\enspace]% after the title body
\titleformat{name=\subparagraph,numberless}%
  [runin]% shape
  {\normalfont\normalsize\sffamily\itshape}% format applied to label+text
  {}% label
  %{\textsc{\MakeTextLowercase{\thesubparagraph}}}% label
  {0pt}% horizontal (with runin) separation between label and title body
  %{\titlingspacedfont\scshape}% {#1}before the title body
  {\spacedlowsmallcaps}% {#1}before the title body
  [\space\textemdash\space\normalfont\normalsize\enspace]% after the title body

%-- New sectioning commands
%--------------------------
%- Usage: \titleclass{<name>}{<class>}[<super-level-cmd>]
%- Example: \titleclass{\subchapter}{straight}[\chapter]
%-          \newcounter{subchapter}
%-          \renewcommand{\thesubchapter}{\Alph{subchapter}}
%---
%- !!! WARNING! A new numbering level is inserted between \subsubsection and \paragraph,
%- so \overparagraph becomes level 4 and \paragraph is shifted to level 5. By the way,
%- the numbering level of sectioning commands must be redefined and the numbering depth
%- must be change, say: \setcounter{secnumdepth}{6} (see below in ToC §)
%- One more time see Enrico Gregorio suggestion:
%- http://tex.stackexchange.com/questions/148827/how-to-count-part-in-chapter/148842#148842
%- See also Gonzalo Medina usefull practical explanations:
%- http://tex.stackexchange.com/questions/60209/how-to-add-an-extra-level-of-sections
%- As the `titlesec' documentation underlines, the `remreset' package may be usefull, see:
%- /opt/texlive/2016/texmf-dist/tex/latex/carlisle/remreset.sty
%---

%-- Overparagraphs: between subsubsection and paragraph in order to have a different layout
\titleclass{\overparagraph}{straight}[\subsubsection]%
\newcounter{overparagraph}[subsubsection]
\renewcommand{\theoverparagraph}{\Alph{overparagraph}}
%\def\thickhrulefill{\leavevmode\leaders\hrule height 2pt\hfill\kern\z@}
\newcommand{\overparagraphlayout}[1]{%
  %\addcontentsline{tdm}{overparagraph}{\protect\numberline{\theoverparagraph}#1}% NO MORE NEEDED
  \itshape\spacedsmallcaps{#1}\space\textcolor{titlingnumbercolor}{\hrulefill}}
\titleformat{\overparagraph}
  [hang]% shape
  {\vspace{2pt}}% format applied to label+text
  {\llap{\textcolor{titlingnumbercolor}{%
         \large\spacedsmallcaps{\theoverparagraph.}}}}% label
  {.5\secLabelSep}% horizontal separation between label and title body
  {\overparagraphlayout}% implicit {#1} before the title body
  []% after the title body
\titleformat{name=\overparagraph,numberless}
  [hang]% shape
  {\vspace{2pt}}% format applied to label+text
  %{\theoverparagraph}% label (cf. doc le déclarer quand même pour comptabilisation)
  {}% label
  {0pt}% horizontal separation between label and title body
  {\overparagraphlayout}% {#1} before the title body
  []% after the title body
\pretocmd{\overparagraph}{\setcounter{paragraph}{0}}{}

%--- Appendix extensions (per chapter/section subappendices as sections or subsections)
%----------------------
%- Borrowed ideas/macros of a simple `subappendices' environment from the `appendix' package
%---

%- Appendix use
\newbool{doc@sectionappendix}
%\pretocmd{\subappendices}{\global\doc@sectionappendixtrue}{}{}
%\apptocmd{\subappendices}{\global\doc@sectionappendixfalse}{}{}

\newbool{@pphyper}
\AtBeginDocument{%
  \@ifpackageloaded{hyperref}{\booltrue{@pphyper}}{}%
}

\newcounter{subappends}
\providecommand{\theH@pps}{\alph{subappends}}

\newenvironment{subappendices}{\par
  \stepcounter{subappends}
  \booltrue{doc@sectionappendix}
  \ifbool{titling@article}{% Section subappendices
    \setcounter{subsection}{0}
    \renewcommand{\thesubsection}{\thesection.\Alph{subsection}}%
    \ifbool{@pphyper}%
      {\renewcommand{\theHsubsection}{\theH@pps.\Alph{section}}}%
      {}
    \@redotocentryAppendix{subsection}
  }{% Chapter subappendices
    \setcounter{section}{0}
    \renewcommand{\thesection}{\Alph{section}}%
    \ifbool{@pphyper}%
      {\renewcommand{\theHsection}{\theH@pps.\Alph{section}}}% Needed for correct hyp. ref pages
      {}
    \@redotocentryAppendix{section}
  }
  }{% Close the multicols if needed (redundant, so useless)
    %\addtocontents{tdm}{\protect\ifmulticolsused\protect\end{multicols}\protect\fi}%
    \boolfalse{doc@sectionappendix}
}

%- Redefining ToC entries
%- Takes care of the page number. If not, sets the page number to the one of chapters.
%- See: https://tex.stackexchange.com/questions/195831/problem-with-titlesec-and-appendix
\newcommand{\@redotocentryAppendix}[1]{% #1 = ToC level (section, subsection, etc.)
  \let\oldacl@pp=\addcontentsline
  \def\addcontentsline##1##2##3{%
    \def\@pptempa{##1}\def\@pptempb{toc}%
    \ifx\@pptempa\@pptempb
      \def\@pptempa{##2}\def\@pptempb{#1}%
      \ifx\@pptempa\@pptempb
        \oldacl@pp{##1}{##2}{##3}% ##3 = section title
      \else
        \oldacl@pp{##1}{##2}{##3}%
      \fi
    \else
       \oldacl@pp{##1}{##2}{##3}%
    \fi
  }
}

%- Controling the layout of subappendices
\BeforeBeginEnvironment{subappendices}{\clearpage\symmetricalpage}%\clearmargin
\AfterEndEnvironment{subappendices}{\asymmetricalpage}

%-- Chapter replacement for appendices and back matter

%- Numbered appendix chapter layout
\newcommand{\numberedAppendixLayout}[1]{%
  \begin{tikzpicture}[remember picture, overlay]
    %- Main header rectangle
    \fill[maincolor, fill opacity=1]
      ([yshift=-\Gm@tmargin]current page.north west) rectangle
      ([yshift=-\chapterHeaderHeigth]current page.north east);
    %- Bottom header rectangle
    \fill[maincolor, fill opacity=1] (current page.south west) rectangle
      ([yshift=\footskip]current page.south east);
    %- Separation lines
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\chapterHeaderHeigth]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=north west] at
      ([yshift=-\Gm@tmargin]current page.north west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    \node[inner sep=0pt, anchor=south west] at
      ([yshift=\footskip]current page.south west)
        {\color{firstcolor}\rule{\paperwidth}{.6mm}};
    %- Chapter title
    \node[inner sep=0pt, anchor=south west,
          font=\fontsize{50pt}{60pt}\selectfont\titlefont] (title) at
          ([yshift=-.8\chapterHeaderHeigth]current page text area.west|-current page.north)
          {\begin{varwidth}{\entirewidth}%
            \FlushLeft%
            \noHyphen\textcolor{secondcolor}{#1}%
          \end{varwidth}};
    %- Chapter label and numbering
    %\node[inner sep=10pt, anchor=south] (label) at (current page marginpar area.north)
    \node[inner sep=0pt, anchor=east] (label) at
      ([xshift=-10mm,yshift=-10mm]current page marginpar area.north east)
        {\normalfont\huge\textcolor{white}{\textsc{\appendixname}~\theappendixchapter}};
    %- Book title in footer
    \node[inner sep=0pt, anchor=south east] at
      ([xshift=\marginparsep+\marginparwidth,
        yshift=-.5\footskip]current page footer area.south east)
        {\small\color{white}
          \spacedsmallcaps{\@doctitle}
          \ifdefempty{\@doctitle}{}{\ifdefempty{\@subtitle}{}{ \textemdash{} }}\textsc{\@subtitle}
          \ifdoc@license% adding licence information if needed
            \ifdefempty{\@copyrightname}{}{\quad\@copyrightsymbol\ }\@copyrightname
            \ifdefempty{\@versiondate}{}{ \textendash{} }\@versiondate
            \ifdefempty{\@docversion}{}{\ifdefempty{\@versiondate}{ \textendash{} }{, }}\@docversion
          \fi};%
  \end{tikzpicture}
}

%-- New sectioning commands for appendix and back chapters (much more easier ToC/LoF/LoT management)
% https://tex.stackexchange.com/questions/328157/why-does-titleclass-remove-my-sections-from-the-toc
\ifbool{titling@article}{}{%
  %- Appendix chapter
  \titleclass{\appendixchapter}[0]{top}
  %\titleclass{\appendixchapter}{straight}[\part]
  \newcounter{appendixchapter}%[part]
  \renewcommand{\theappendixchapter}{\Alph{appendixchapter}}
  \titleformat{\appendixchapter}[display]
    {\cleardoublepage}{}{0pt}{\numberedAppendixLayout}
    [% Chapter after code to display ToC (sub)sections in two columns for mainmatter and appendices
      \ifnum\value{appendixchapter}>0
        \addtocontents{tdm}{%
          \protect\vspace{\aftertocchapterspace}%
          \protect\setuptocmulticols\protect\begin{tocmulticols}{2}\protect\multicolsusedtrue}%
      \fi%
    ]
  \titleformat{name=\appendixchapter,numberless}[display]
    {\cleardoublepage}{}{0pt}{\numberlessChapterLayout}[]
  \titlespacing*{\appendixchapter}{0pt}{0pt}{\chapterHeaderHeigth+1.5cm-\Gm@tmargin-40pt}
  %- Back matter style: numberless layout (references, glossaries, index, etc.)
  \titleclass{\backchapter}[0]{top}
  %\titleclass{\backchapter}{straight}[\part]
  \newcounter{backchapter}%[part]
  %\renewcommand{\thebackchapter}{\Roman{backchapter}}
  %\renewcommand{\thebackchapter}{}
  \titleformat{\backchapter}[display]
    {\cleardoublepage}{}{0pt}{\numberlessChapterLayout}
    [\addtocontents{tdm}{\protect\vspace{\aftertocchapterspace}}]
  %\titleformat{name=\chapter,numberless}[display]{}{}{0pt}{\numberlessChapterLayout}[]
  \titleformat{name=\backchapter,numberless}[display]
    {\cleardoublepage}{}{0pt}{\numberlessChapterLayout}
    [\addtocontents{tdm}{\protect\vspace{\aftertocchapterspace}}]
  \titlespacing*{\backchapter}{0pt}{0pt}{\chapterHeaderHeigth+1.5cm-\Gm@tmargin-40pt}
}

%-- Sectioning spaces management / Arrangement des espaces des commandes de sectionnement
%---------------------------------------------------------------------------------------------------

%-- Spacing before and after sectionning stuff (with `titlesec' package)

%- Usage: \titlespacing{<sectioning-command>}{<leftsep>}{<beforesep>}{<aftersep>}{<right-sep>}
%- The <right-sep> option is only available to "hang", "block", "display" shapes.
%- The starred version kills the indentation of the paragraph following the title.
%- Adding tolerance may be done in <beforesep> and <aftersep>.
%---

\ifbool{titling@usefrenchlanguage}{% French style
  %\titlespacing*{\chapter}{0pt}{0pt}{\chapterHeaderHeigth+1.5cm-\Gm@tmargin-40pt}
  \titlespacing{\section}{0pt}{20pt plus 2pt minus 2pt}{12pt plus 2pt minus 4pt}%
  \titlespacing{\subsection}{0pt}{16pt plus 2pt minus 2pt}{6pt plus 2pt minus 2pt}
  \titlespacing{\subsubsection}{0pt}{12pt plus 2pt minus 2pt}{1pt plus 1pt minus 1pt}
  \titlespacing{\overparagraph}{0pt}{3pt plus 1.5pt minus 1.5pt}{\parskip}
  \titlespacing{\paragraph}{0pt}{2pt plus .75pt minus .75pt}{0pt}
  \titlespacing{\subparagraph}{0pt}{0pt}{0pt}
}{% English style: No indentation after a sectioning command
  %\titlespacing*{\chapter}{0pt}{0pt}{\chapterHeaderHeigth+1.5cm-\Gm@tmargin-40pt}
  \titlespacing*{\section}{0pt}{\baselineskip}{0pt}
  \titlespacing*{\subsection}{0pt}{\baselineskip}{2\parskip}
  \titlespacing*{\subsubsection}{0pt}{.5\baselineskip}{\parskip}
  \titlespacing*{\overparagraph}{0pt}{.5\baselineskip}{\parskip}
  \titlespacing*{\paragraph}{0pt}{2pt}{0pt}
  \titlespacing*{\subparagraph}{0pt}{0pt}{0pt}
}




















































