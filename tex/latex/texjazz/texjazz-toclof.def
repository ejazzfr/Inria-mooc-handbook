%%
%% texjazz-toclof.def
%%
%% A LaTeX file to configure sectionning and titling instructions.
%%
%% Copyright (c) 2020-2021 ejazz.
%%
% --------------------------------------------------------------------------------------------------
% This work is part of the TeXjazz bundle. It may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% The Current Maintainer of this work is ejazz <ejazz.fr@gmail.com>.
%
% This work consists of the files:
%     `texjazz-toclof.def' and `texjazz-toclof[-fr].tex' (not yet fully available).
% --------------------------------------------------------------------------------------------------

%-- File identification
%----------------------

\ProvidesFile{texjazz-toclof.def}%
  [2021/02/08 v0.1a − Configuring the table of contents and other lists defined environments]

%-- ToC and List of... design
%----------------------------

\RequirePackage{titletoc}% `titlesec' package companion for ToCs, `List of...', ect.

%-- Syntax of `titletoc' package: (very powerful, but complex code and redefine standard commands)
%-- \titlecontents{ section }[ left-margin ]{ above-code }
%-- { numbered-entry-format }{ numberless-entry-format }
%-- { filler-page-format }[ below-code ][ end code ]
%-- \titlecontents* (star version) displays the contents in a paragraphed mode
%---

%--- For the record:
%- Échelle de profondeur [-2;5] (avec etoc, niveau -2 pour book) : -2=book (memoir.cls), -1=part,
%- 0=chapter, 1=section, 2=subsection, 3=subsubsection, 4=paragraph, 5=subparagraph
%---

\setcounter{secnumdepth}{6}% profondeur de numérotation des sections
\setcounter{tocdepth}{3}% profondeur de la table des matières principale : 3 = subsubsection

%---
%- The desired default behaviour is to display (sub)sections in two colums for the main ToC, with
%- the help of the `multicols' package. To access to others partial ToC in one column without
%- interfering with the main ToC, this latter is store in a separate file "jobname.tdm", where
%- "tdm" stands for "Table des matières" in French. For one column main Toc, nothing is modified.
%---
%- Working solution (without partial ToCs) is given by Christian Hupfer after posting to TeX.SE:
%- Cf. http://tex.stackexchange.com/questions/355285/two-columns-book-toc-misunderstood-behaviour
%- For using also partial ToCs, a standalone main ToC file is defined separately (because of
%- an issue with the `titletoc' package).
%- After posting to TeX-SE, the solution is given by 'touhami' by redefining \addcontentsline
%- See: http://tex.stackexchange.com/questions/359603/
%---

%-- Two columns main ToC
\newcommand\twocolumnstableofcontents{%
  \ifdoc@article% From article.cls
    \renewcommand*{\contentsname}{\textcolor{secondcolor}{\large\tocfont\spacedsmallcaps{Sommaire}}}
    \setlength{\columnseprule}{.4pt}
    \renewcommand{\columnseprulecolor}{\color{secondcolor}}
    \begingroup\centering
    \begin{tcolorbox}[
      width=.9\linewidth,
      enhanced, breakable,
      %blank,
      nobeforeafter,
      %arc=0pt, outer arc=0pt,
      %boxsep=0pt,
      left=8pt, right=8pt,
      top=8pt, bottom=4pt,
      %boxrule=0pt,
      colback=black!5,%black!10,
      colframe=firstcolor,
      %toptitle=4pt, bottomtitle=4pt,
      %colbacktitle=black!10, coltitle=secondcolor,
      %titlerule=1pt,
      %fonttitle=\large\tocfont,
      %title={},
      %overlay={
      %  \node[anchor=west,fill=white,inner xsep=6pt]
      %    at ([xshift=10pt]frame.north west) {Sommaire};
       %}
     ]
     \contentsname\space\textcolor{firstcolor}{\hrulefill}\par
     \vspace{\baselineskip}
    \begin{multicols}{2}
      \@starttoc{toc}%
    \end{multicols}
    \vspace{.5\baselineskip}\textcolor{firstcolor}{\hrule}
    \end{tcolorbox}
    \par\endgroup
  \else
    %- Two columns main ToC: loading "jobname.tdm" with two columns inside
    %- Also had a bookmark in the definition (see below)
    \chapter*{\contentsname\@mkboth{\MakeUppercase\contentsname}{\MakeUppercase\contentsname}}%
    \@starttoc{tdm}% TDM stands for "Table des matières" in French
  \fi
  %\addtocontents{tdm}{% Resetting to default values after the multicolumns ToC
  %  \protect\resettocmulticols% Default = 0; Global → has to bet reset
  %}%
}
%\ifdoc@article
  \let\tableofcontents\twocolumnstableofcontents
%\fi

%- One column main ToC
\newcommand{\sommaire}{%
  \chapter*{\contentsname\@mkboth{\MakeUppercase{\contentsname}}{\MakeUppercase{\contentsname}}}%
  \@starttoc{toc}
}


%-- Partial chapter ToC utilities (see \sideChapterToc definition below)

\newlength{\tocboxheight}
\setlength{\tocboxheight}{40pt}% default: must be recalculated below

%- Box height measurement of the partial ToC
\newtcolorbox{measurebox}[2][]{% From http://tex.stackexchange.com/questions/203194/
  blank, parbox=false,%show bounding box,
  overlay={\xdef#2{\tcb@height}},
  #1
}

%- Defining a command for line stretching into side chapter ToCs
\newcommand*{\sidetocbaselinestretch}{1.2}

%- Designing the partial ToC with tcolorbox
\newcommand{\chaptertoc@tcolorbox}{%
  \begin{measurebox}{\tocboxheight}
    \begin{tcolorbox}[
      width=\marginparwidth,
      enhanced,
      nobeforeafter,
      arc=0pt, outer arc=0pt,
      boxsep=0pt,
      left=8pt, right=8pt,
      top=8pt, bottom=4pt,
      boxrule=0pt,
      colback=black!10, %colframe=black!40,
      %toptitle=4pt, bottomtitle=4pt,
      colbacktitle=black!10, coltitle=secondcolor,
      %titlerule=1pt,
    ]
    \ifdoc@english
      {\tocfont\large\textcolor{secondcolor}{In brief}}%
    \else
      {\tocfont\large\textcolor{secondcolor}{\spacedlowsmallcaps{Sommaire}}}%
    \fi
    \par\vspace{-.5\baselineskip}%
    \textcolor{secondcolor}{\rule{\linewidth}{1pt}}%
    \par
    \renewcommand{\baselinestretch}{\sidetocbaselinestretch}
    %\printcontents[chapters]{c}{1}{\setcounter{tocdepth}{3}}% For 2016/03/21 version
    %- New usage: \printcontents[<name>]{<prefix>}{<start-level>}[<toc-depth>]{<toc-code>}
    \printcontents[chapters]{c}{1}[3]{}% New update 2019/09/09
    %\printcontents{}{1}[3]{}% New update 2019/09/09
    \end{tcolorbox}%
  \end{measurebox}
}

%-- Chapter margin mini-ToC
\newcommand{\sidechaptertoc}{%
  \startcontents[chapters]% For 2016/03/21 version and new update 2019/09/09 of titlesec package
  %\marginelement{% Based on floating LaTeX marginpar: DOESN'T WORK with multicol ToC
  \marginnote{% Much more efficient here for the margin vertical space management
    \chaptertoc@tcolorbox
  }\unskip% Needed for vertical alignment. See: http://tex.stackexchange.com/questions/117695/
  \mparshift{\tocboxheight}% Shifting down the next margin notes (from `marginfix' package)
  \marginpar{\vspace*{\baselineskip}}% More space / starts margin display at the correct position
}

%-- Conditional on multicolumn use in ToC/TdM

%- First working attempt from Christian Hupfer to my question:
%- https://tex.stackexchange.com/questions/355285/two-columns-book-toc-misunderstood-behaviour
\newif\ifmulticolsused
%\pretocmd{\multicols}{\global\multicolsusedtrue}{}{}
%\apptocmd{\endmulticols}{\global\multicolsusedfalse}{}{}

%- Redefining multicolumns environments to fit our needs for the ToC (unbalanced: multicols* like)
%- The approach is definitly not straightforward and traditional because of the internal definition
%- adopted by Franck Mittelbach for multicols environment. A solution is proposed by egreg, see:
%- https://tex.stackexchange.com/questions/351389/
%- (re-newenvironment-that-contains-environment-itself-with-an-argument-in-latex)

%- Keep copies of the original to be on the safe side
\let\jazzmulticols\multicols
\let\endjazzmulticols\endmulticols
\letcs\jazzmulticolsstar{multicols*}
\letcs\endjazzmulticolsstar{endmulticols*}
\patchcmd{\jazzmulticolsstar}{\begin{multicols}}{}{}{}
\patchcmd{\endjazzmulticolsstar}{\end{multicols}}{}{}{}

%- Wow! May be one day I'd be able to really understand this code... Read TeXbook!
\newcommand{\newmulticolsenvironment}[3]{%
  \newenvironment{#1}{#2\jazzmulticols}{}%
  \toks@=\expandafter{\endjazzmulticols#3}%
  \expandafter\edef\csname end#1\endcsname{\the\toks@}%
  \expandafter\patchcmd\csname end#1\endcsname
    {\@checkend{multicols}}
    {\@checkend{#1}}
    {}{}%
  \newenvironment{#1*}
    {#2\jazzmulticolsstar\begin{#1}}
    {\endjazzmulticolsstar\end{#1}#3}%
}

%- For an unknown reason multicol* give errors and without star it works!!! Very strange! FIXME TODO
\newmulticolsenvironment{tocmulticols}
  {\global\multicolsusedtrue}%<some stuff before>
  {\global\multicolsusedfalse}%<some stuff after>

%-- If part(s) exist(s)

\newif\ifdoc@parts
\pretocmd{\part}{\global\doc@partstrue}{}{}

%-- Partial part and chapter ToC management (appendices and so on)
\pretocmd{\appendixchapter}{%
  \ifnum\value{appendixchapter}=0
    \stopcontents[chapters]%
  \fi
}{}{}
\pretocmd{\backmatter}{%
  \ifdoc@parts
    \stopcontents[parts]%
  \fi
}{}{}

%-- Automatic detection of figures/tables/etc. for LoF/LoT/etc. within chapters (see TeX.SE links)

%- Initial definitions of the chapter info (name and number)
\def\thischaptertitle{}
\def\thischapternumber{}
\def\thischapterpage{}
\def\thisappendixchaptertitle{}
\def\thisappendixchapternumber{}% See above hook for \appendixchapter
%- It seems that we have to define the same settings for the part sectioning (FIXME)
\def\thisparttitle{}
\def\thispartnumber{}
%- Toogle (= bascule in French) to detect if there are figures and so forth in each chapter
\newtoggle{noFigs}
\newtoggle{noTabs}
\newtoggle{noExos}
\newtoggle{noQuiz}
\newtoggle{noDocs}
\newtoggle{noVids}
\newtoggle{noCodes}
\newtoggle{noListings}
%- See: https://tex.stackexchange.com/questions/106587/how-to-include-appendices-name-in-lof
\newbool{appendices}% Equivalent to \doc@appendix? YES FIXME
\setbool{appendices}{false}

%-- Redefining macros to add part and side partial ToCs + automatic numbering of figures/etc.
\ifdoc@article\else
  \let\originalpart\part
  \renewcommand{\part}{
    \startcontents[parts]%
    \originalpart
  }
  \apptocmd{\@part}{%
    \gdef\thisparttitle{#1}\gdef\thispartnumber{\thepart}%
    \global\toggletrue{noFigs}\global\toggletrue{noTabs}%
    \global\toggletrue{noExos}\global\toggletrue{noQuiz}%
    \global\toggletrue{noVids}\global\toggletrue{noDocs}%
    \global\toggletrue{noCodes}\global\toggletrue{noListings}%
  }{}{}
  \let\originalchapter\chapter
  \RenewDocumentCommand{\chapter}{s o m}{%
    \IfBooleanTF{#1}{%
      \originalchapter*{#3}\gdef\thischaptertitle{#3}}{%
      \IfNoValueTF{#2}%
        {\originalchapter{#3}\gdef\thischaptertitle{#3}}
        {\originalchapter[#2]{#3}\gdef\thischaptertitle{#2}}%
      % Automatic control of figures/tables/etc. numbering for LoF/LoT/etc.
      \ifnum\value{secnumdepth} > -1
        \gdef\thischapternumber{\thechapter}%
      \else
        \global\let\thischapternumber\@empty%
      \fi
      \global\let\thischapterHref\@currentHref % hyperref
      \global\toggletrue{noFigs}\global\toggletrue{noTabs}%
      \global\toggletrue{noExos}\global\toggletrue{noQuiz}%
      \global\toggletrue{noDocs}\global\toggletrue{noVids}%
      \global\toggletrue{noCodes}\global\toggletrue{noListings}%
      \sidechaptertoc
    }%
  }%
  \let\originalappendixchapter\appendixchapter
  \RenewDocumentCommand{\appendixchapter}{s o m}{%
    \IfBooleanTF{#1}{%
      \originalappendixchapter*{#3}\gdef\thisappendixchaptertitle{#3}}{%
      \IfNoValueTF{#2}%
        {\originalappendixchapter{#3}\gdef\thisappendixchaptertitle{#3}}
        {\originalappendixchapter[#2]{#3}\gdef\thisappendixchaptertitle{#2}}%
      % Automatic control of figures/tables/etc. numbering for LoF/LoT/etc.
      \ifnum\value{secnumdepth}>-1 %
        \gdef\thisappendixchapternumber{\theappendixchapter}%
      \else
        \global\let\thisappendixchapternumber\@empty
      \fi
      \global\let\thisappendixchapterHref\@currentHref % hyperref
      \global\toggletrue{noFigs}\global\toggletrue{noTabs}%
      \global\toggletrue{noExos}\global\toggletrue{noQuiz}%
      \global\toggletrue{noDocs}\global\toggletrue{noVids}%
      \global\toggletrue{noCodes}\global\toggletrue{noListings}%
    }%
  }%
  \let\originalsection\section
  \RenewDocumentCommand{\section}{s o m}{%
    \IfBooleanTF{#1}
      {\originalsection*{#3}}
      {\IfNoValueTF{#2}
        {\originalsection{#3}}
        {\originalsection[#2]{#3}}}%
  }%
  %- Taking into account a two colums main ToC with entries in the file jobname.tdm
  \pretocmd{\part}{%
    % Close the multicols if needed in the Toc/TdM file
    \addtocontents{tdm}{%\protect\vspace*{\fill}
      %\protect\ifmulticolsused\protect\vspace{\fill}\protect\end{tocmulticols}\protect\fi%
      \protect\ifmulticolsused\protect\end{tocmulticols}\protect\fi%
      \protect\vspace{\beforetocpartspace}%
    }%
  }{}{}
  \pretocmd{\chapter}{%
    % Close the multicols if needed in the Toc/TdM file
    \addtocontents{tdm}{%
      %\protect\ifmulticolsused\protect\vspace{\fill}\protect\end{tocmulticols}\protect\fi
      \protect\ifmulticolsused\protect\end{tocmulticols}\protect\fi
      \protect\vspace{\beforetocchapterspace}%
      }%
  }{}{}
  \pretocmd{\appendixchapter}{%
    % Close the multicols if needed in the Toc/TdM file
    \addtocontents{tdm}{%
      \protect\ifmulticolsused\protect\end{tocmulticols}\protect\fi
      \protect\vspace{\beforetocchapterspace}%
      }%
  }{}{}
  \pretocmd{\backchapter}{%
    % Close the multicols if needed in the Toc/TdM file
    \addtocontents{tdm}{%
      \protect\ifmulticolsused\protect\end{tocmulticols}\protect\fi
      \protect\vspace{\beforetocchapterspace}%
      }%
  }{}{}
  \AfterLastShipout{% Close the multicols if needed in the Toc/TdM file
    % Must be after \AtEndDocument hook and \clearpage but before the main .aux file is closed
    \immediate\write\@auxout{\noexpand\@writefile{tdm}{%
      \noexpand\ifmulticolsused\noexpand\vspace{\fill}%
      \noexpand\end{tocmulticols}\noexpand\fi\noexpand\vspace*{\fill}}}%
    \immediate\write\@auxout{\noexpand\@writefile{tdm}{%
      \noexpand\contentsfinish}}% must close the ToC file with the titletoc package and partial ToCs
  }
\fi

%-- General handbook ToC, LoF, LoT, etc. layout

\RequirePackage{framed}% helper package

%-- Lengths
\newlength{\tocnumberWidth}
\settowidth{\tocnumberWidth}{\Huge\bfseries\scshape 999}
\newlength{\tocnumberSep}
\setlength{\tocnumberSep}{10pt}

%-- Utility for chapter and part ToC layout
%-- From G. Medina settings: http://tex.stackexchange.com/questions/35825/pretty-table-of-contents

%- Original layout by G. Medina (see http://tex.stackexchange.com/questions/35825 for using)
\renewenvironment{leftbar}{% Used for partial part ToC layout
  \def\FrameCommand{%
    \hspace{1.5\tocnumberWidth}%\hspace{6em}%
    {\color{secondcolor}\vrule width 2pt depth 6pt}\hspace{1em}%
  }%\hspace{10pt}}%
  %\MakeFramed {\advance\hsize-\width \FrameRestore}%\vskip2pt
  \MakeFramed{\parshape 1 0cm \dimexpr\textwidth-1.5\tocnumberWidth\relax\FrameRestore}\vskip2pt%
}{\endMakeFramed}
%- Adapted layout
\newenvironment{tocleftbar}{% Used for ToC chapter layout
  \def\FrameCommand{%
    \hspace{\tocnumberWidth}% Page chapter number width
    \hspace{\tocnumberSep}% Separation from page chapter number to left bar
    \textcolor{secondcolor}{\vrule width 2pt depth 6pt}%
    \hspace{\tocnumberSep}% Separation between left bar and "framed" text contents
    %\hspace{2pt}% Compensated bar width to align the chapter title with the section title
  }
  %- \hsize = measured text width (see framed.sty source file)
  %- \width = measured extra width added by the frame via \fb@frw macro (see framed.sty source file)
  \MakeFramed{\advance\hsize-\width \FrameRestore}\vskip 2pt%
  %\MakeFramed{\parshape 1 0cm \dimexpr\textwidth-1.5\tocnumberWidth\relax\FrameRestore}\vskip2pt%
}{\endMakeFramed}

%-- New macros to manually ajust (in the core document) the vertical space between ToC entries

%-- https://tex.stackexchange.com/questions/119730/ (global-scope-or-permanent-length-or-savebox)
%-- https://tex.stackexchange.com/questions/406015/ (defining-macro-gsetlength-as-global-setlength)

%-- For \deflength see `etoolbox' doc. (like \setlength but support glue and global assignment)

\def\globalpgfsetlength#1#2{%
  \expandafter\pgfmath@onquick#2\pgfmath@%
    {%
      % Ok, quick version:
      \begingroup%
        \pgfmath@selectfont%
        \pgfmath@x#2\unskip%
        \pgfmath@returnone\pgfmath@x%
      \endgroup%
      \global#1\pgfmathresult pt\relax% here add \global before #1
    }%
    {%
      \pgfmathparse{#2}%
      \global#1\pgfmathresult pt\relax% and here
    }%
    \ignorespaces%
}

%- Lengths as command (for redefining in the core document)
\newcommand{\beforetocpartspace}{0pt}
\newcommand{\aftertocpartspace}{0pt}
\newcommand{\beforetocchapterspace}{0pt}
\newcommand{\aftertocchapterspace}{0pt}
\newcommand{\beforelofchapterspace}{0pt}
\newcommand{\afterlofchapterspace}{0pt}
\newcommand{\beforelotchapterspace}{0pt}
\newcommand{\afterlotchapterspace}{0pt}
\newcommand{\beforelovchapterspace}{0pt}
\newcommand{\afterlovchapterspace}{0pt}
\newcommand{\beforelodchapterspace}{0pt}
\newcommand{\afterlodchapterspace}{0pt}
\newcommand{\beforeloqchapterspace}{0pt}
\newcommand{\afterloqchapterspace}{0pt}
\newcommand{\beforelocchapterspace}{0pt}
\newcommand{\afterlocchapterspace}{0pt}
\newcommand{\beforelolchapterspace}{0pt}
\newcommand{\afterlolchapterspace}{0pt}
\newcommand{\beforeloechapterspace}{0pt}
\newcommand{\afterloechapterspace}{0pt}

%-- Part ToC layout

\newcommand{\parttoclayout}[1]{%
  \begin{tcolorbox}[
    enhanced jigsaw,
    colframe=darkelectricblue, colback=maincolor!20,
    fontupper={\Huge\titlefont},
    arc = 0pt, boxrule = 0pt, boxsep = 0pt,
    left = 16pt, right = 16pt, top = 4pt, bottom = 4pt,
    %drop shadow=firstcolor,
    %drop fuzzy shadow=firstcolor,
    shadow={4pt}{-4pt}{0pt}{firstcolor},
    %before skip={4pt plus 2pt minus 2pt},
    %after skip={4pt plus 1pt minus 2pt},
    %after skip={2pt plus 1pt minus 1pt},
    before skip={4pt plus 1pt minus 1pt},
    after skip={0pt plus 1pt minus 1pt},
    %nobeforeafter,
    oversize]
    \hypersetup{linkcolor=secondcolor}
    \textcolor{black}{\spaceskip .25em%
      \frenchtextnumberpart{jazzpart} \jazzpartname\space\textemdash\space}%
    %- Below \spaceskip is given for inter-word spacing (no more inter-word spacing with fontspec)
    %- Other solutions may be settled with \textsl microtype macro or \parskipfill redefining
    %- See, e.g.: https://tex.stackexchange.com/questions/270906/
    %\addtracked[16]{\spaceskip .5em\relax#1}\textcolor{firstcolor}{\enspace\hrulefill}
    \addtracked[14]{\spaceskip .36em\relax#1}\textcolor{firstcolor}{~~\hrulefill}%
  \end{tcolorbox}%
}

%-- Chapter ToC layout

%- Define original Medina's \chaptertoclayout with the `framed' package (leads to page break issues)
\newcommand*{\jazzchaptername}{}
\newcommand{\leftbarchaptertoclayout}[1]{%
  \setlength{\fboxsep}{0pt}
  \parbox{\tocnumberWidth}{\hfill\Huge\bfseries\scshape\color{secondcolor}\thecontentspage}%
  \vspace*{-2.5\baselineskip}%
  \begin{tocleftbar}
    \ifdefempty{\jazzchaptername}{}{% \ifdefempty is defined by the `etoolbox' package
      \textsc{\small\tocfont\textcolor{black!55}{\jazzchaptername~\normalfont\thecontentslabel}}%
      \newline}
    \Large\tocfont\spacedsmallcaps{#1}
  \end{tocleftbar}
  \addvspace{-2\baselineskip}
}
%- Define \chaptertoclayout with the `tcolorbox' package (no page break issue)
\newcommand{\tcboxchaptertoclayout}[1]{%
  \begin{tcolorbox}[
    %use height from group=chaptertocLayout,% this option needs two LaTeX runs
    colframe=white, colback=white,
    fontupper={\Huge\bfseries\scshape\color{secondcolor}},
    arc=0pt, boxrule=0pt, boxsep=0pt,% default=1mm
    left=0pt, right=0pt,% additional to boxsep, default=4mm
    top=4pt, bottom=0pt,% default=2mm
    halign=flush right, valign=center,
    width=\tocnumberWidth,%-\tocnumberSep
    before={}, after=\hspace{\tocnumberSep},
    box align=top,% See p.79
    before skip={4pt plus 2pt minus 2pt},
    ]\thecontentspage%
  \end{tcolorbox}%
  \begin{tcolorbox}[% \tcbox macro can't be used here: line breaks are not allowed (see doc. p.14)
    enhanced,
    %height=2.25cm, %add to height=10pt, %equal height group=chaptertocLayout,
    add to natural height=6pt,
    colframe=secondcolor, colback=white,
    fontupper={\tocfont},
    arc=0pt, boxrule=0pt, boxsep=0pt,% default=1mm
    left=\tocnumberSep, right=0pt, % additional to boxsep, default=4mm
    top=0pt, bottom=0pt,% default=2mm
    %leftrule=2pt, %rightrule=6mm, %middle = 2pt,% additional to boxsep
    frame hidden,
    borderline west={2pt}{0pt}{secondcolor},
    before={}, after={},% after={\newline},
    after skip={0pt plus 2pt minus 2pt},
    halign=flush left, valign=top,
    %text width=\textwidth-\tocnumberWidth-2\tocnumberSep-2pt,% 2pt = left rule width
    width=\textwidth-\tocnumberWidth-\tocnumberSep,
    box align=top,% See p.79
    ]\ifdefempty{\jazzchaptername}
      {\small ~~\\% for backmatter, other way: use \if@mainmatter \ifdoc@appendix conditionals
        \Large\spacedsmallcaps{#1}}
      {\scshape\small\textcolor{black!55}{\jazzchaptername~\normalfont\thecontentslabel}\\
        \Large\spacedsmallcaps{#1}}%
  \end{tcolorbox}%
}
%\let\chaptertoclayout=\leftbarchaptertoclayout
\let\chaptertoclayout=\tcboxchaptertoclayout

%-- Entries styles of the main ToC

\newcommand\toccontentspage[1][\thecontentspage]{% Derived from `titletoc' package
  \hb@xt@\@pnumwidth{\hfil\footnotesize\textit{#1}}%
  \hspace*{-\@pnumwidth}}

%- Main traditional "full page chapter" ToC (conditional between "Workbook" and "Handbook")
\ifdoc@article
  %- Workbook/article main ToC: no chapter entry
  \titlecontents{section}
    [10pt]% left indentation
    {\contentsmargin{0pt}\addvspace{.5ex}\small\tocfont}
    {\contentslabel{12pt}}% numbered entry format
    {}% numberless entry format
    %{\hspace{0.5em}\nobreak\textcolor{jazzgray}{\small\itshape\thecontentspage}}% page number
    {}% no page numbering
  \titlecontents{subsection}
    [26pt]% left indentation
    {\contentsmargin{0pt}\small\normalfont}% above code
    {\contentslabel{16pt}}% numbered entry format
    {}% numberless entry format
    {\hspace{0.5em}\nobreak\textcolor{maincolor}{\normalfont\small\textit{\thecontentspage}}}
    %{}% no page numbering
  \titlecontents*{subsubsection}
    [24pt]% left indentation
    {\contentsmargin{0pt}\footnotesize\normalfont}
    %{\makebox[16pt][l]{\thecontentslabel}}% box = trop rigide
    {\thecontentslabel\hskip.5em plus .1em minus .25em}
    %{\thecontentslabel\spaceskip=.75em plus .25em minus .25em}
    {}
    {\normalfont\small}
    %\spaceskip=.9\fontdimen2\font plus .2\fontdimen3\font minus 2.2\fontdimen4\font}
    [\allowbreak\hskip.333em plus .15em minus .3em\textcolor{maincolor}{\textemdash{}}%
                \hskip.333em plus .15em minus .2em\allowbreak]
    [\parfillskip 0pt plus 1fil\relax]
  \titlecontents*{overparagraph}
    [5pt]
    {\scriptsize}%\contentsmargin{0pt}}
    {\thecontentslabel.\hskip.5em}
    {}
    {\hskip.33em\allowbreak\normalfont\footnotesize\allowbreak}%
    [\allowbreak\hskip.33em]%
    [\parfillskip 0pt plus 1fil\relax]
\else
  %- Handbook/book main ToC
  \titlecontents{part}[0pt]
    {\contentsmargin{0pt}}
    {\parttoclayout}
    {}{}[]
  \titlecontents{chapter}[0pt]
    {\contentsmargin{0pt}}
    {\let\jazzchaptername=\chaptertitlename\chaptertoclayout}
    {}{}[\nopagebreak]
    %\addtocontents{tdm}{\protect\setcounter{unbalance}{0}}
  \titlecontents{appendixchapter}[0pt]
    {\contentsmargin{0pt}}
    {\let\jazzchaptername=\appendixname\chaptertoclayout}
    {}{}[\nopagebreak]
  \titlecontents{backchapter}[0pt]
    {\contentsmargin{0pt}}
    {\chaptertoclayout}
    {}{}[\nopagebreak]
  \titlecontents{section}[\tocnumberWidth+\tocnumberSep+12pt]
    {\vskip 4pt plus 1pt minus 2.5pt\small\tocfont}
    {\contentslabel{12pt}}
    {}{}[\vskip .75ex plus .25ex minus .25ex]
  \titlecontents{subsection}[\tocnumberWidth+\tocnumberSep+12pt+16pt]
    {\vskip 1pt plus 1pt minus 1pt\small}
    {\contentslabel{16pt}}%{\makebox[20pt][l]{\normalfont\thecontentslabel}}
    {}{\nobreak\color{darkgray}\toccontentspage}
    %[\vspace{.1\baselineskip plus .05\baselineskip minus .05\baselineskip}]
  \titlecontents*{subsubsection}[\tocnumberWidth+\tocnumberSep+12pt+16pt]
    {\addvspace{-.25ex}\contentsmargin{0cm}\footnotesize}
    {\thecontentslabel\hskip.5em plus .25em minus .1em}{}
    {}%
    %{\hskip.33em\allowbreak\normalfont
    % \textcolor{jazzgray}{\scriptsize[\itshape\thecontentspage\upshape]}\allowbreak}%
    [\allowbreak\hskip.333em plus .15em minus .3em\textcolor{maincolor}{\textemdash{}}%
                \hskip.333em plus .15em minus .2em\allowbreak]
    %[\parfillskip=0pt plus 1fil\relax]% LuaTeX: fi, fil, fill, filll TeX.SE: /questions/350669/
    %[\parfillskip=0pt plus .75\textwidth\relax]
    %[\hfill]
  \titlecontents*{overparagraph}[5pt]
    {\contentsmargin{0pt}\footnotesize}
    {\thecontentslabel.\hskip.5em}{}
    {\hskip.33em\allowbreak\normalfont\footnotesize\allowbreak}%
    [\allowbreak\hskip.33em]%
    [\parfillskip 0pt plus 1fil\relax]
\fi% article-workbook/book-handbook ToC

%-- Redefining ToC entry from the `titletoc' package to add control of the layout for partial ToCs
%-- https://tex.stackexchange.com/questions/57202/

%\AtBeginDocument{%
%  \g@addto@macro{\tableofcontents}{\let\l@lastnumber\relax}
%  \let\old@ttl@tocentry\ttl@tocentry
%  \def\ttl@tocentry#1#2#3#4#5#6#7#8{%
%    \edef\l@thisnumber{#8}% store current page number
%    \old@ttl@tocentry{#1}{#2}{#3}{#4}{#5}{#6}{#7}{%
%      \ifnum\ttl@b>1\relax% the value here determines which levels will ALWAYS have page numbers
%        \ifx\l@thisnumber\l@lastnumber% if the numbers are the same
%          \leavevmode\phantom{\l@thisnumber}%
%        \else% if the numbers differ
%          \l@thisnumber
%        \fi
%      \else% if the level has to have the page number always
%        \l@thisnumber
%      \fi%
%    }%
%    \edef\l@lastnumber{#8}% save the page number for the next ToC line
%  }
%}

%-- For controling \numberline see:
%-- https://tex.stackexchange.com/questions/45569/inline-table-of-contents

%-- Redefining the style to match the needs of the partial side chapter Tocs

\titlecontents{csection}
  [8pt]% left indentation
  {\addvspace{.5ex}\contentsmargin{0pt}\tocfont\footnotesize}% contentsmargin = rigth margin
  {\contentslabel{8pt}}% numbered entry format
  {}% numberless entry format
  %{\hspace{0.5em}\nobreak\textcolor{jazzgray}{\small\itshape\thecontentspage}}% page number
  {}% no page numbering
\titlecontents{csubsection}
  [20pt]% left indentation
  {\contentsmargin{0pt}\normalfont\scriptsize}% above code
  {\contentslabel{12pt}}% numbered entry format
  {}% numberless entry format
  {\hspace{0.5em}\nobreak\textcolor{maincolor}{\normalfont\scriptsize\textit{\thecontentspage}}}
  %{}% no page numbering
\titlecontents*{csubsubsection}
  [20pt]% left indentation
  {\contentsmargin{0pt}%
   \normalfont\fontsize{6.4pt}{7pt}\selectfont
   \setlength{\RaggedRightLeftskip}{20pt}% From ragged2e.sty: left margin
   \setlength{\RaggedRightRightskip}{0pt plus 4em}% Right margin tolerance, default=2em
   \RaggedRight%
  }
  %{\makebox[16pt][l]{\thecontentslabel}}% with makebox = too rigid
  {\thecontentslabel\nobreak\hskip 2pt plus .4pt minus .4pt}% if fill right
  {}{}
  %\spaceskip=.9\fontdimen2\font plus .2\fontdimen3\font minus 2.2\fontdimen4\font}
  [\hskip 2pt plus .4pt minus .4pt%
   \raisebox{.75pt}{\color{maincolor}\normalfont\fontsize{3pt}{0pt}\selectfont\faSquare}%
   \hskip 2pt plus .4pt minus .4pt\allowbreak]
  %[\parfillskip 0pt plus 1filll\relax]

%-- Redefining the style to match the needs of the partial part Tocs

\titlecontents{pchapter}
  [0pt]% Indenting
  {\vspace{\baselineskip}\contentsmargin{0pt}}%
  {\parbox{\tocnumberWidth}{\hfill\large\bfseries\scshape\color{secondcolor}\thecontentspage}%
    \vspace*{-2.3\baselineskip}%
    \leftbar\textsc{\footnotesize\tocfont\textcolor{firstcolor}{%
                    \chaptertitlename~\normalfont\thecontentslabel\\}}%
                    \normalsize\tocfont\spacedsmallcaps}%
  {}%
  {\endleftbar\addvspace{-.5\baselineskip}}
  [\vspace{0pt}]
\titlecontents{pappendixchapter}
  [0pt]% Indenting
  {\vspace{\baselineskip}\contentsmargin{0pt}}%
  {\parbox{\tocnumberWidth}{\hfill\large\bfseries\scshape\color{secondcolor}\thecontentspage}%
    \vspace*{-2.3\baselineskip}%
    \leftbar\textsc{\footnotesize\tocfont\textcolor{firstcolor}{%
                    \appendixname~\normalfont\thecontentslabel\\}}%
                    \normalsize\tocfont\spacedsmallcaps}%
  {}%
  {\endleftbar\addvspace{-.5\baselineskip}}
  [\vspace{0pt}]
\titlecontents{pbackchapter}
  [0pt]% Indenting
  {\vspace{\baselineskip}\contentsmargin{0pt}}%
  {\parbox{\tocnumberWidth}{\hfill\large\bfseries\scshape\color{secondcolor}\thecontentspage}%
    \vspace*{-2.3\baselineskip}%
    \leftbar\normalsize\tocfont\spacedsmallcaps}%
  {}%
  {\endleftbar\addvspace{-.5\baselineskip}}
  [\vspace{0pt}]
\titlecontents{psection}
  [1.5\tocnumberWidth+20pt]%[\tocnumberWidth]%[23pt]
  {\addvspace{.5ex}\small\tocfont}
  {\contentslabel{14pt}}
  {}
  {}%{\hspace{0.5em}\nobreak\normalfont\itshape\color{darkgray}\contentspage}


%---------------------------------------------------------------------------------------------------
%---- Lists of figures, tables, etc.
%---------------------------------------------------------------------------------------------------

\newcommand{\listofexercises}{%
  %\tcblistof[\chapter*]{loe}{\listexercisename}%
  \chapter*{\listexercisename}
  %\hypertarget{listofexercises}{}
  \@starttoc{loe}
}
\newcommand{\listofquizzes}{%
  %\tcblistof[\chapter*]{loq}{\listquizname}%
  \chapter*{\listquizname}
  %\hypertarget{listofquizzes}{}
  \@starttoc{loq}
}
\renewcommand{\listofvideos}{% There is a side effect with the 'newfloat' package (see doc. p.4)
  %\tcblistof[\chapter*]{lov}{\listvideoname}%
  \chapter*{\listvideoname}
  \@starttoc{lov}
}
%\renewcommand{\listofcodes}{% \renewcommand if defined with the 'newfloat' package
%  %\tcblistof[\chapter*]{loc}{\listcodename}%
%  \chapter*{\listcodename}
%  \@starttoc{loc}
%}
%\renewcommand{\listoflistings}{% \renewcommand because defined by the 'minted' package
%  %\tcblistof[\chapter*]{loc}{\listlistingname}%
%  \chapter*{\listlistingname}
%  \@starttoc{lol}
%}
\newcommand{\listofdocuments}{%
  %\tcblistof[\chapter*]{lod}{\listdocumentname}%
  \chapter*{\listdocumentname}
  \@starttoc{lod}
}

%-- Layout of lists of something (the same as ToC, i.e. chapters)

%-- With titletoc package, see: https://tex.stackexchange.com/questions/353947/
%-- (change-tcolorbox-tcblistof-font-formatting-to-match-documents-other-lists)

\newcommand\listcontentspage[1][\thecontentspage]{% Derived from `titletoc' package
  \hb@xt@\@pnumwidth{\hfil\footnotesize[\textit{#1}]}%
  \hspace*{-\@pnumwidth}}

\ifdoc@article\else
  \titlecontents{figure}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\figurename\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  \titlecontents{table}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\tablename\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  \titlecontents{exercise}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\exercisename\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  % Below it leads to an error with update 2019/09/09 of the `titlesec' package: "already defined"
  %\newcommand{\ttll@exercise}{-1000}
  \titlecontents{quiz}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\quizname\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  % Below it leads to an error with update 2019/09/09 of the `titlesec' package: "already defined"
  %\newcommand{\ttll@quiz}{-1000}
  \titlecontents{video}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\videoname\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  % Below it leads to an error with update 2019/09/09 of the `titlesec' package: "already defined"
  %\newcommand{\ttll@video}{-1000}
  \titlecontents{code}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\codename\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  % Below it leads to an error with update 2019/09/09 of the `titlesec' package: "already defined"
  %\newcommand{\ttll@code}{-1000}
  \titlecontents{listing}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\listingname\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  % Below it leads to an error with update 2019/09/09 of the `titlesec' package: "already defined"
  %\newcommand{\ttll@listing}{-1000}
  \titlecontents{document}[\tocnumberWidth+\tocnumberSep+2pt]
    {\small}
    {\contentspush{\documentname\space\makebox[18pt][l]{\small\thecontentslabel}\textemdash\enspace}}
    {}
    {\nobreak\hspace{.5em}\textcolor{darkgray}{\footnotesize[\textit{\thecontentspage}]}\allowbreak}
    [\vskip 0pt plus .5pt minus .5pt]
  % Below it leads to an error with update 2019/09/09 of the `titlesec' package: "already defined"
  %\newcommand{\ttll@document}{-1000}
\fi


































































